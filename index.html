<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss: –°–∏–º—É–ª—è—Ç–æ—Ä –ì–æ—Ä–æ–¥–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∏–ª–∏ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2f0e8; /* –õ–µ–≥–∫–∏–π –∑–µ–ª–µ–Ω—ã–π/–≥–æ–ª—É–±–æ–π —Ñ–æ–Ω –¥–ª—è "–≥–æ—Ä–æ–¥—Å–∫–æ–≥–æ" –≤–∏–¥–∞ */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            overflow-y: auto;
        }

        .game-container {
            width: 100%;
            max-width: 600px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            padding: 30px;
            text-align: center;
            border: 6px solid #10b981; /* –ú—è—Ç–Ω–æ-–∑–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ */
        }

        .header-section {
            background-color: #065f46; /* –¢–µ–º–Ω–æ-–∑–µ–ª–µ–Ω—ã–π */
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .balance-display {
            font-size: 3rem;
            font-weight: 800;
            color: #fcd34d; /* –ó–æ–ª–æ—Ç–æ–π/–Ø–Ω—Ç–∞—Ä–Ω—ã–π */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .collect-button {
            background-color: #ef4444; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å–±–æ—Ä–∞ */
            color: white;
            padding: 15px 25px;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 0 #b91c1c;
            transform: translateY(0);
        }

        .collect-button:active {
            box-shadow: 0 2px 0 #b91c1c;
            transform: translateY(2px);
        }

        .industry-card {
            background-color: #f0fdf4; /* –û—á–µ–Ω—å —Å–≤–µ—Ç–ª—ã–π –∑–µ–ª–µ–Ω—ã–π */
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid #34d399;
            text-align: left;
            transition: all 0.3s ease;
        }

        .industry-card.purchased {
            background-color: #ccfbf1; /* –ë–ª–µ–¥–Ω—ã–π –±–∏—Ä—é–∑–æ–≤—ã–π */
        }
        
        .industry-card.unpurchased:hover {
            background-color: #d1fae5;
        }
        
        .progress-bar-container {
            height: 12px;
            background-color: #a7f3d0;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-bar {
            height: 100%;
            background-color: #059669; /* –ù–∞—Å—ã—â–µ–Ω–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π */
            transition: width 0.1s linear;
        }
        
        .manager-toggle.active {
            background-color: #3b82f6; /* –°–∏–Ω–∏–π –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ */
            box-shadow: 0 2px 0 #1d4ed8;
        }
        
        .manager-toggle:active {
            transform: translateY(1px);
            box-shadow: 0 1px 0 #1d4ed8;
        }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –¥–æ—Ö–æ–¥–∞ */
        .income-popup {
            position: fixed;
            color: #10b981; /* –ó–µ–ª–µ–Ω—ã–π */
            font-size: 28px;
            font-weight: 800;
            pointer-events: none;
            animation: floatup 1.5s ease-out forwards;
            z-index: 1000;
            text-shadow: 1px 1px 2px #000;
        }

        @keyframes floatup {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-70px) scale(0.8); opacity: 0; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div id="loading-status" class="text-center p-5 hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-4 border-indigo-500"></div>
        <p class="mt-3 text-indigo-600 font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...</p>
    </div>
    <div id="game-ui" class="hidden">
        <div class="header-section">
            <h1 class="text-3xl font-extrabold mb-1">TashBoss</h1>
            <p class="text-sm font-light mb-3">–°–∏–º—É–ª—è—Ç–æ—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–º</p>
            <div class="balance-display" id="score-display">0 BSS</div>
            <p class="text-xs font-light mt-1">
                –î–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É (–ø–∞—Å—Å–∏–≤–Ω—ã–π): <span id="auto-income-display" class="font-bold text-yellow-300">0 BSS/—Å</span>
            </p>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±–æ—Ä–∞ –≤—Å–µ–π –ø—Ä–∏–±—ã–ª–∏ -->
        <button id="collect-all-button" class="collect-button w-full mb-6" disabled>
            –°–æ–±—Ä–∞—Ç—å –í—Å—é –ü—Ä–∏–±—ã–ª—å (0 BSS)
        </button>
        
        <hr class="my-6 border-gray-200">

        <h2 class="text-2xl font-bold text-gray-800 mb-4">–û—Ç—Ä–∞—Å–ª–∏ (–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏)</h2>
        <div id="industries-list">
            <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∏ –æ—Ç—Ä–∞—Å–ª–µ–π -->
        </div>

        <button id="save-button" class="mt-6 p-2 bg-blue-500 text-white text-sm rounded-lg shadow-md hover:bg-blue-600 transition-all active:scale-95" disabled>
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é
        </button>
        <div id="save-status" class="mt-2 text-xs text-gray-500">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫.</div>
    </div>
    
    <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
    <div id="error-message" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden"></div>
</div>


<script type="module">
    // –ò–º–ø–æ—Ä—Ç Firebase SDK (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Canvas)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously, 
        signInWithCustomToken, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        onSnapshot 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï CANVAS (MANDATORY) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- –ù–ê–°–¢–†–û–ô–ö–ò –ò–ì–†–´ –ò –°–û–°–¢–û–Ø–ù–ò–ï ---
    const GAME_STATE_DOC_ID = 'tashboss_v1_state';
    const AUTOSAVE_INTERVAL = 15000; // 15 —Å–µ–∫—É–Ω–¥

    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    let lastGameLoopTime = Date.now();
    let totalAutoIncome = 0; // –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±—â–µ–≥–æ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞

    let gameState = {
        score: 0,
        industries: {}, // { id: { level: N, lastCollect: timestamp, isManaged: boolean, managerCost: N } }
    };
    
    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ç—Ä–∞—Å–ª–µ–π (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞)
    const INDUSTRIES_DATA = [
        { id: 'clean', name: '–£–±–æ—Ä–∫–∞ —É–ª–∏—Ü', startCost: 100, baseIncome: 1, baseCycleTime: 60, emoji: 'üßπ', managerCost: 500 },
        { id: 'utility', name: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —Å–ª—É–∂–±—ã', startCost: 300, baseIncome: 3, baseCycleTime: 50, emoji: 'üí°', managerCost: 1500 },
        { id: 'transport', name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', startCost: 1000, baseIncome: 8, baseCycleTime: 45, emoji: 'üöå', managerCost: 5000 },
        { id: 'parks', name: '–ü–∞—Ä–∫–∏ –∏ –∑–æ–Ω—ã –æ—Ç–¥—ã—Ö–∞', startCost: 3000, baseIncome: 20, baseCycleTime: 40, emoji: 'üå≥', managerCost: 15000 },
        { id: 'business', name: '–ú–∞–ª—ã–π –±–∏–∑–Ω–µ—Å', startCost: 8000, baseIncome: 50, baseCycleTime: 35, emoji: '‚òï', managerCost: 40000 },
        { id: 'factory', name: '–ó–∞–≤–æ–¥—ã –∏ —Ñ–∞–±—Ä–∏–∫–∏', startCost: 20000, baseIncome: 120, baseCycleTime: 30, emoji: 'üè≠', managerCost: 100000 },
        { id: 'airquality', name: '–ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞', startCost: 50000, baseIncome: 200, baseCycleTime: 25, emoji: 'üå¨Ô∏è', managerCost: 250000 },
        { id: 'itpark', name: 'IT-–ø–∞—Ä–∫', startCost: 120000, baseIncome: 500, baseCycleTime: 20, emoji: 'üíª', managerCost: 600000 },
        { id: 'tourism', name: '–¢—É—Ä–∏–∑–º', startCost: 250000, baseIncome: 1000, baseCycleTime: 15, emoji: 'üïå', managerCost: 1250000 },
        { id: 'international', name: '–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ', startCost: 1000000, baseIncome: 5000, baseCycleTime: 10, emoji: 'ü§ù', managerCost: 5000000 },
    ];
    
    // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
    const gameUI = document.getElementById('game-ui');
    const scoreDisplay = document.getElementById('score-display');
    const autoIncomeDisplay = document.getElementById('auto-income-display');
    const industriesList = document.getElementById('industries-list');
    const loadingStatus = document.getElementById('loading-status');
    const errorMessageEl = document.getElementById('error-message');
    const saveButton = document.getElementById('save-button');
    const collectAllButton = document.getElementById('collect-all-button');

    // --- –£–¢–ò–õ–ò–¢–´ ---

    function formatNumber(num) {
        if (typeof num !== 'number') return '0';
        num = Math.floor(num);
        if (num >= 1e12) return (num / 1e12).toFixed(1) + ' T';
        if (num >= 1e9) return (num / 1e9).toFixed(1) + ' B';
        if (num >= 1e6) return (num / 1e6).toFixed(1) + ' M';
        if (num >= 1e3) return (num / 1e3).toFixed(1) + ' K';
        return num.toFixed(0);
    }
    
    function showError(message) {
        errorMessageEl.textContent = '–û—à–∏–±–∫–∞: ' + message;
        errorMessageEl.classList.remove('hidden');
        setTimeout(() => errorMessageEl.classList.add('hidden'), 5000);
    }
    
    function logMessage(message) {
        console.log(`[TASHBOSS] ${message}`);
    }

    // --- –§–û–†–ú–£–õ–´ –ò–ì–†–û–í–û–ô –ú–ï–•–ê–ù–ò–ö–ò ---

    // 1. –†–∞—Å—á–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –æ—Ç—Ä–∞—Å–ª–∏ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
    function calculateIndustryStats(data, level) {
        const currentLevel = level || 0;
        
        // –£—Ä–æ–≤–µ–Ω—å 0 - –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–µ—Ç –¥–æ—Ö–æ–¥–∞
        if (currentLevel === 0) {
            return {
                nextCost: data.startCost, // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏
                currentIncome: 0,
                currentCycle: data.baseCycleTime * 1000,
            };
        }

        // –£—Ä–æ–≤–µ–Ω—å N:
        // –î–æ—Ö–æ–¥: baseIncome * Level (–õ–∏–Ω–µ–π–Ω—ã–π —Ä–æ—Å—Ç –¥–æ—Ö–æ–¥–∞)
        const income = data.baseIncome * currentLevel;
        
        // –í—Ä–µ–º—è —Ü–∏–∫–ª–∞: baseCycleTime * (1 / (1 + 0.05 * Level)) - –ù–µ–±–æ–ª—å—à–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ (5% —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞ —É—Ä–æ–≤–µ–Ω—å)
        const cycleTimeMs = data.baseCycleTime * 1000 * (1 / (1 + 0.05 * (currentLevel - 1)));
        
        // –°—Ç–æ–∏–º–æ—Å—Ç—å —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: startCost * 1.5 ^ Level
        // –£—Ä–æ–≤–µ–Ω—å 1 –ø–æ–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ startCost
        // –£—Ä–æ–≤–µ–Ω—å 2 —Å—Ç–æ–∏—Ç startCost * 1.5^1
        const nextCost = Math.floor(data.startCost * Math.pow(1.5, currentLevel));
        
        return {
            nextCost: nextCost,
            currentIncome: income,
            currentCycle: Math.max(cycleTimeMs, 5000), // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª 5 —Å–µ–∫—É–Ω–¥
        };
    }
    
    // 2. –†–∞—Å—á–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
    function calculateEarnedProfit(data, industryState) {
        if (industryState.level === 0) return 0;
        
        const stats = calculateIndustryStats(data, industryState.level);
        const now = Date.now();
        const timeElapsed = now - (industryState.lastCollect || now);
        
        // –°–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ –ø—Ä–æ—à–ª–æ
        const cyclesCompleted = Math.floor(timeElapsed / stats.currentCycle);
        
        if (cyclesCompleted < 1) return 0;
        
        const earned = cyclesCompleted * stats.currentIncome;
        
        return {
            earned: earned,
            cyclesCompleted: cyclesCompleted,
            timeToNextCycle: stats.currentCycle - (timeElapsed % stats.currentCycle)
        };
    }
    
    // 3. –†–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
    function calculateTotalAutoIncome() {
        totalAutoIncome = 0;
        INDUSTRIES_DATA.forEach(data => {
            const state = gameState.industries[data.id];
            if (state && state.level > 0 && state.isManaged) {
                const stats = calculateIndustryStats(data, state.level);
                // –î–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É (BSS/—Å)
                totalAutoIncome += stats.currentIncome / (stats.currentCycle / 1000); 
            }
        });
    }

    // --- –õ–û–ì–ò–ö–ê FIREBASE –ò –°–û–•–†–ê–ù–ï–ù–ò–Ø ---

    async function initFirebase() {
        if (!firebaseConfig) {
            showError('Firebase config –Ω–µ –Ω–∞–π–¥–µ–Ω.');
            return;
        }

        loadingStatus.classList.remove('hidden');

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    logMessage(`–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. User ID: ${userId}`);
                    loadGameState();
                    saveButton.disabled = false;
                    
                    // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                    setInterval(saveGameState, AUTOSAVE_INTERVAL);
                    gameUI.classList.remove('hidden');
                } else {
                    logMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω.');
                    userId = null;
                    isAuthReady = false;
                    loadingStatus.classList.add('hidden');
                }
            });

        } catch (e) {
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Firebase: ' + e.message);
        }
    }

    function getGameStateDocRef() {
        if (!db || !userId) return null;
        // –ü—É—Ç—å –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        const collectionPath = `artifacts/${appId}/users/${userId}/game_data`;
        return doc(db, collectionPath, GAME_STATE_DOC_ID);
    }

    function loadGameState() {
        const docRef = getGameStateDocRef();
        if (!docRef) return;
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
        onSnapshot(docRef, (docSnap) => {
            loadingStatus.classList.add('hidden');
            
            if (docSnap.exists()) {
                const loadedState = docSnap.data();
                gameState.score = loadedState.score || 0;
                gameState.industries = loadedState.industries || {};
                logMessage('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ Firestore.');
            } else {
                logMessage('–ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (–¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω).');
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞
                gameState.score = INDUSTRIES_DATA[0].startCost; // –ù–∞—á–∏–Ω–∞–µ–º —Å BSS –Ω–∞ –ø–æ–∫—É–ø–∫—É –ø–µ—Ä–≤–æ–π –æ—Ç—Ä–∞—Å–ª–∏
            }
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è lastCollect –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            INDUSTRIES_DATA.forEach(data => {
                if (gameState.industries[data.id] && !gameState.industries[data.id].lastCollect) {
                    // –ï—Å–ª–∏ –æ—Ç—Ä–∞—Å–ª—å –∫—É–ø–ª–µ–Ω–∞, –Ω–æ –Ω–µ—Ç lastCollect, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ –≤ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
                    gameState.industries[data.id].lastCollect = Date.now();
                }
            });

            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            gameLoop();
        }, (error) => {
            loadingStatus.classList.add('hidden');
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–∑ Firestore: ' + error.message);
        });
    }

    async function saveGameState() {
        const docRef = getGameStateDocRef();
        if (!docRef || !isAuthReady) return;

        const statusEl = document.getElementById('save-status');
        saveButton.disabled = true;
        statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

        try {
            await setDoc(docRef, gameState, { merge: true });
            statusEl.textContent = `–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()} (OK)`;
        } catch (e) {
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e.message);
            statusEl.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è!';
        } finally {
            saveButton.disabled = false;
        }
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ –ò –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø ---

    function buyIndustry(id) {
        const data = INDUSTRIES_DATA.find(d => d.id === id);
        if (!data) return;

        // –ï—Å–ª–∏ –æ—Ç—Ä–∞—Å–ª—å –Ω–µ –∫—É–ø–ª–µ–Ω–∞ (level 0), –ø–æ–∫—É–ø–∞–µ–º Level 1
        let currentState = gameState.industries[id] || { level: 0, isManaged: false, managerCost: data.managerCost };
        const stats = calculateIndustryStats(data, currentState.level);
        
        const cost = stats.nextCost;
        
        if (gameState.score >= cost) {
            gameState.score -= cost;
            currentState.level += 1;
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è —Å–±–æ—Ä–∞ –¥–ª—è –Ω–æ–≤–æ–π/—É—Ä–æ–≤–Ω—è
            currentState.lastCollect = Date.now(); 

            gameState.industries[id] = currentState;
            
            updateUI();
            saveGameState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
            
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞, –¥–∞–µ–º –±–æ–Ω—É—Å BSS –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
            if (currentState.level === 1) {
                showPopup(`+${formatNumber(data.baseIncome)} BSS`, document.getElementById(`buy-btn-${id}`));
            }
        } else {
            showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BSS –¥–ª—è –ø–æ–∫—É–ø–∫–∏ ${data.name}. –ù—É–∂–Ω–æ ${formatNumber(cost)} BSS.`);
        }
    }
    
    function toggleManager(id) {
        const data = INDUSTRIES_DATA.find(d => d.id === id);
        let currentState = gameState.industries[id];
        if (!currentState || currentState.level === 0) return; // –ù–µ–ª—å–∑—è –Ω–∞–Ω—è—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–ª—è –Ω–µ–∫—É–ø–ª–µ–Ω–Ω–æ–π –æ—Ç—Ä–∞—Å–ª–∏

        if (currentState.isManaged) {
            // –£–≤–æ–ª—å–Ω—è–µ–º (—Å–Ω–∏–º–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
            currentState.isManaged = false;
        } else {
            // –ù–∞–Ω–∏–º–∞–µ–º (–≤–∫–ª—é—á–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
            const managerCost = data.managerCost;
            if (gameState.score >= managerCost) {
                gameState.score -= managerCost;
                currentState.isManaged = true;
            } else {
                showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BSS –¥–ª—è –Ω–∞–π–º–∞ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ. –ù—É–∂–Ω–æ ${formatNumber(managerCost)} BSS.`);
                return;
            }
        }
        
        gameState.industries[id] = currentState;
        updateUI();
        saveGameState();
    }
    
    function collectProfit(id, visualElement) {
        const data = INDUSTRIES_DATA.find(d => d.id === id);
        let currentState = gameState.industries[id];
        if (!currentState || currentState.level === 0) return 0;
        
        const { earned, cyclesCompleted } = calculateEarnedProfit(data, currentState);
        
        if (earned > 0) {
            gameState.score += earned;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–±–æ—Ä–∞ –Ω–∞ –≤—Ä–µ–º—è, –∫–æ–≥–¥–∞ –±—ã–ª –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ü–∏–∫–ª
            const stats = calculateIndustryStats(data, currentState.level);
            const timeElapsed = Date.now() - currentState.lastCollect;
            currentState.lastCollect += cyclesCompleted * stats.currentCycle;

            // –ï—Å–ª–∏ —ç—Ç–æ —Ä—É—á–Ω–æ–π —Å–±–æ—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ
            if (visualElement) {
                showPopup(`+${formatNumber(earned)} BSS`, visualElement);
            }
            
            // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞, —Å–±—Ä–æ—Å lastCollect –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–¥–µ—Å—å
            if (currentState.isManaged) {
                currentState.lastCollect = Date.now();
            }

            gameState.industries[id] = currentState;
            return earned;
        }
        return 0;
    }
    
    function collectAllProfit() {
        if (!isAuthReady) return;
        
        let totalCollected = 0;
        
        // –í—Ä—É—á–Ω—É—é —Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–±—ã–ª—å —Å–æ –≤—Å–µ—Ö –æ—Ç—Ä–∞—Å–ª–µ–π, –≥–¥–µ –Ω–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        INDUSTRIES_DATA.forEach(data => {
            const state = gameState.industries[data.id];
            if (state && state.level > 0 && !state.isManaged) {
                totalCollected += collectProfit(data.id, collectAllButton);
            }
        });
        
        if (totalCollected > 0) {
            updateUI();
            saveGameState();
        } else {
            showError('–ù–µ—Ç –ø—Ä–∏–±—ã–ª–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–±–æ—Ä–∞.');
        }
    }

    // --- –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ---

    function updateUI() {
        if (!isAuthReady) return;

        const totalManualCollectable = renderIndustries();
        
        scoreDisplay.textContent = `${formatNumber(gameState.score)} BSS`;
        
        calculateTotalAutoIncome();
        autoIncomeDisplay.textContent = `${formatNumber(totalAutoIncome.toFixed(2))} BSS/—Å`;

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–æ–±—Ä–∞—Ç—å –í—Å–µ"
        collectAllButton.textContent = `–°–æ–±—Ä–∞—Ç—å –í—Å—é –ü—Ä–∏–±—ã–ª—å (${formatNumber(totalManualCollectable)} BSS)`;
        collectAllButton.disabled = totalManualCollectable === 0;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –æ—Ç—Ä–∞—Å–ª–µ–π
    function renderIndustries() {
        industriesList.innerHTML = '';
        let totalManualCollectable = 0;

        INDUSTRIES_DATA.forEach(data => {
            let currentState = gameState.industries[data.id] || { level: 0, isManaged: false, managerCost: data.managerCost || 0 };
            const level = currentState.level;
            const isPurchased = level > 0;
            const stats = calculateIndustryStats(data, level);
            
            let collectableProfit = 0;
            let progressWidth = 0;
            
            if (isPurchased) {
                const profitInfo = calculateEarnedProfit(data, currentState);
                collectableProfit = profitInfo.earned;
                
                // –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
                const timeElapsed = Date.now() - currentState.lastCollect;
                const timeInCurrentCycle = timeElapsed % stats.currentCycle;
                progressWidth = (timeInCurrentCycle / stats.currentCycle) * 100;
                
                if (!currentState.isManaged) {
                    totalManualCollectable += collectableProfit;
                }
            }

            const card = document.createElement('div');
            card.id = `industry-card-${data.id}`;
            card.className = `industry-card ${isPurchased ? 'purchased' : 'unpurchased'}`;
            
            if (!isPurchased) {
                // –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ (Level 1)
                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-extrabold text-xl text-gray-800">${data.emoji} ${data.name}</h3>
                            <p class="text-sm text-gray-500">${data.description}</p>
                        </div>
                        <button id="buy-btn-${data.id}" 
                            class="p-3 bg-green-500 text-white font-semibold rounded-lg shadow-md transition-all active:scale-95 disabled:opacity-50"
                            ${gameState.score < stats.nextCost ? 'disabled' : ''}>
                            –ö—É–ø–∏—Ç—å (Lvl 1) –∑–∞ ${formatNumber(stats.nextCost)} BSS
                        </button>
                    </div>
                `;
            } else {
                // –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —É–ª—É—á—à–µ–Ω–∏—è
                const isManaged = currentState.isManaged;
                
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-extrabold text-xl text-gray-900">${data.emoji} ${data.name} <span class="text-lg text-indigo-600">(Lvl ${level})</span></h3>
                        <span class="text-sm font-semibold text-gray-500">${stats.currentIncome} BSS / ${Math.ceil(stats.currentCycle / 1000)} —Å–µ–∫.</span>
                    </div>
                    
                    <div class="progress-bar-container mb-3">
                        <div class="progress-bar" style="width: ${progressWidth}%;"></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±–æ—Ä–∞ –ø—Ä–∏–±—ã–ª–∏ -->
                        <button id="collect-btn-${data.id}" 
                            class="p-3 font-semibold rounded-lg transition-all active:scale-95 col-span-1 
                            ${isManaged ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-red-500 text-white shadow-md hover:bg-red-600'}"
                            ${collectableProfit === 0 || isManaged ? 'disabled' : ''}>
                            –°–æ–±—Ä–∞—Ç—å (${formatNumber(collectableProfit)} BSS)
                        </button>

                        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–º–∞/—É–≤–æ–ª—å–Ω–µ–Ω–∏—è –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ -->
                        <button id="manager-btn-${data.id}" 
                            class="manager-toggle p-3 font-semibold rounded-lg transition-all active:scale-95 col-span-1 shadow-md
                            ${isManaged ? 'active bg-blue-500 text-white hover:bg-blue-600' : 'bg-yellow-400 text-gray-800 hover:bg-yellow-500'}"
                            ${!isManaged && gameState.score < data.managerCost ? 'disabled' : ''}>
                            ${isManaged ? '–£–≤–æ–ª–∏—Ç—å (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)' : `–ù–∞–Ω—è—Ç—å –û—Ç–≤. (${formatNumber(data.managerCost)} BSS)`}
                        </button>

                        <!-- –ö–Ω–æ–ø–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è -->
                        <button id="upgrade-btn-${data.id}" 
                            class="p-3 bg-green-500 text-white font-semibold rounded-lg shadow-md transition-all active:scale-95 col-span-1 disabled:opacity-50"
                            ${gameState.score < stats.nextCost ? 'disabled' : ''}>
                            –£–ª—É—á—à–∏—Ç—å (Lvl ${level + 1}) –∑–∞ ${formatNumber(stats.nextCost)} BSS
                        </button>
                    </div>
                `;
            }
            
            industriesList.appendChild(card);

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            if (!isPurchased) {
                document.getElementById(`buy-btn-${data.id}`).addEventListener('click', () => buyIndustry(data.id));
            } else {
                document.getElementById(`collect-btn-${data.id}`).addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    collectProfit(data.id, e.target);
                    updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞
                    saveGameState();
                });
                document.getElementById(`manager-btn-${data.id}`).addEventListener('click', () => toggleManager(data.id));
                document.getElementById(`upgrade-btn-${data.id}`).addEventListener('click', () => buyIndustry(data.id));
            }
        });
        
        return totalManualCollectable;
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –¥–æ—Ö–æ–¥–∞
    function showPopup(text, visualElement) {
        if (!visualElement) return;

        const rect = visualElement.getBoundingClientRect();
        
        const popupEl = document.createElement('div');
        popupEl.textContent = text;
        popupEl.classList.add('income-popup');
        
        // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        popupEl.style.left = `${rect.left + rect.width / 2}px`;
        popupEl.style.top = `${rect.top}px`;
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫ body
        document.body.appendChild(popupEl);

        // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        popupEl.addEventListener('animationend', () => {
            popupEl.remove();
        });
    }

    // --- –ì–õ–ê–í–ù–´–ô –ò–ì–†–û–í–û–ô –¶–ò–ö–õ (60 FPS) ---
    function gameLoop() {
        if (!isAuthReady) {
            requestAnimationFrame(gameLoop);
            return;
        }

        const now = Date.now();
        const deltaTime = (now - lastGameLoopTime) / 1000; // Delta time –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        lastGameLoopTime = now;
        
        let shouldSave = false;
        
        // 1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –ø—Ä–∏–±—ã–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º–∏
        INDUSTRIES_DATA.forEach(data => {
            let state = gameState.industries[data.id];
            if (state && state.level > 0 && state.isManaged) {
                const collected = collectProfit(data.id);
                if (collected > 0) {
                    showPopup(`+${formatNumber(collected)} BSS`, document.getElementById(`industry-card-${data.id}`));
                    shouldSave = true;
                }
            }
        });

        // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–≤
        updateUI();
        
        // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∞–≤—Ç–æ-—Å–æ–±—ã—Ç–∏–µ
        if (shouldSave) {
            saveGameState();
        }

        requestAnimationFrame(gameLoop);
    }


    // --- –¢–û–ß–ö–ê –í–•–û–î–ê ---
    window.onload = function () {
        initFirebase();
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ–±—Ä–∞—Ç—å –í—Å–µ"
        collectAllButton.addEventListener('click', collectAllProfit);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        saveButton.addEventListener('click', saveGameState);
    }

</script>

</body>
</html>
