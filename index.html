<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- Официальный SDK Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #0a1829 0%, #1f2e46 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
        }

        #app {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            text-align: center;
        }

        .card {
            background-color: #1f2e46;
            border: 1px solid #3a4b62;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .balance-display {
            font-size: 3rem;
            font-weight: 900;
            color: #4a90e2;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }
        .buy-button:not(:disabled):hover {
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.5);
        }
        
        /* Для плавного исчезновения баннера */
        #messageBanner {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1 class="text-3xl font-extrabold text-white mb-6">TashBoss Clicker</h1>
        
        <!-- Баннер сообщений (не alert) -->
        <div id="messageBanner" class="hidden transition duration-500 ease-in-out opacity-100" style="display: none;"></div>

        <!-- Статус загрузки / Ошибка -->
        <div id="statusMessage" class="card text-lg text-yellow-400">Инициализация WebApp...</div>

        <!-- Основной контент игры -->
        <div id="gameContent" class="hidden">
            
            <!-- Дисплей Баланса -->
            <div class="card bg-gray-900/50 p-6">
                <p class="text-gray-400 text-sm">Ваш текущий баланс (BossCoin):</p>
                <!-- Добавляем ID пользователя для отладки -->
                <p class="text-xs text-gray-500 mb-2">UID: <span id="userIdDisplay">...</span></p>
                
                <div class="balance-display" id="balanceDisplay">0.00</div>
                <p class="text-gray-400 text-xs mt-2" id="passiveIncomeDisplay">Пассивный доход/сек: 0.00</p>
            </div>
            
            <!-- Сбор Дохода -->
            <div class="card bg-gray-800 p-4">
                <button id="collectIncomeButton" class="w-full py-3 px-4 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition duration-200" disabled>
                    Собрать доход (0.00 BC)
                </button>
            </div>

            <!-- Секция Покупки Секторов -->
            <div class="mt-6">
                <h2 class="text-xl font-bold mb-4 text-left">Купить Сектора</h2>
                <div id="sectorsContainer">
                    <!-- Карточки секторов будут добавлены JavaScript из app.js -->
                </div>
            </div>
            
            <p id="timer-status" class="text-xs text-gray-500 mt-4"></p>
        </div>
    </div>

    <!-- Подключение Логики -->
    <script type="module" src="./app.js"></script>
    <script type="module">
        // --- Скрипт Инициализации Firebase и Аутентификации ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, getIdToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Глобальные Настройки ---
        // Жестко заданный (фейковый) config для инициализации Firebase Client SDK
        // ВАЖНО: Project ID должен совпадать с тем, что в ключе сервисного аккаунта на бэкенде.
        const firebaseConfig = { projectId: "tashboss-clicker-app" }; 
        const API_BASE_URL = window.location.origin;

        // --- DOM Элементы ---
        const statusMessage = document.getElementById('statusMessage');

        // Включаем логирование Firebase
        setLogLevel('debug');


        /**
         * 1. Надежно получает ID пользователя Telegram.
         * @returns {string | null}
         */
        function getTelegramUserId() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe.user) {
                // Возвращаем ID в виде строки, как требует Firebase Auth
                return window.Telegram.WebApp.initDataUnsafe.user.id.toString();
            }
            console.error("Telegram WebApp SDK user data not found.");
            statusMessage.classList.add('text-red-500');
            statusMessage.textContent = "❌ Ошибка: Приложение должно быть запущено внутри Telegram.";
            return null;
        }

        /**
         * 2. Запрашивает Firebase Custom Token у бэкенда.
         * @param {string} telegramUserId - ID пользователя Telegram.
         * @returns {Promise<string | null>} Токен или null в случае ошибки.
         */
        async function fetchCustomToken(telegramUserId) {
            try {
                statusMessage.textContent = "Получение токена аутентификации (шаг 2/4)...";
                // Используем fetch для обмена Telegram ID на Firebase Custom Token
                const response = await fetch(`${API_BASE_URL}/auth-token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_user_id: telegramUserId })
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.token; // Custom Token (строка)
                }
                
                const errorData = await response.json().catch(() => ({ detail: 'Неизвестная ошибка сервера' }));
                throw new Error(`Ошибка HTTP: ${response.status}. ${errorData.detail}`);

            } catch (error) {
                console.error("Failed to fetch custom token:", error);
                statusMessage.textContent = `Ошибка: Не удалось получить токен. ${error.message}`;
                return null;
            }
        }

        /**
         * 3. Инициализирует Firebase и выполняет вход.
         */
        async function initializeAppAndAuth(customToken) {
            try {
                statusMessage.textContent = "Инициализация Firebase (шаг 3/4)...";
                
                const app = initializeApp(firebaseConfig);
                const authClient = getAuth(app);
                
                statusMessage.textContent = "Вход в систему (шаг 4/4)...";

                // Вход с помощью Custom Token
                const userCredential = await signInWithCustomToken(authClient, customToken);
                
                const userUID = userCredential.user.uid;
                console.log(`✅ Успешный вход в Firebase. UID: ${userUID}`);
                
                // Получаем ID Token, который будем использовать для всех запросов к API
                // ID Token будет автоматически обновляться Firebase SDK при необходимости
                const idToken = await getIdToken(userCredential.user);

                // Вызываем глобальную функцию в app.js для запуска основной логики игры
                if (window.initAppAfterAuth) {
                    window.initAppAfterAuth(idToken, userUID);
                } else {
                    console.error("initAppAfterAuth is not defined in app.js.");
                }
                
                // Скрываем статус и показываем контент
                statusMessage.classList.add('hidden');
                
                // Показываем кнопку закрытия Telegram WebApp
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.MainButton.setText("Закрыть игру").show().onClick(() => {
                    window.Telegram.WebApp.close();
                });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                statusMessage.textContent = `Ошибка: Не удалось войти в Firebase. ${error.message}`;
                statusMessage.classList.remove('hidden');
            }
        }
        
        // --- Главная функция инициализации ---
        async function main() {
            const telegramUserId = getTelegramUserId();

            if (!telegramUserId) return;

            const customToken = await fetchCustomToken(telegramUserId);
            
            if (customToken) {
                await initializeAppAndAuth(customToken);
            }
        }
        
        // Запускаем приложение при загрузке DOM
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
