<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- Официальный SDK Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #0a1829 0%, #1f2e46 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
        }

        #app {
            width: 100%;
            max-width: 420px;
            padding: 20px;
            text-align: center;
        }

        .card {
            background-color: #1f2e46;
            border: 1px solid #3a4b62;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .balance-display {
            font-size: 3rem;
            font-weight: 900;
            color: #4a90e2;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }
        .buy-button:not(:disabled):hover {
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.5);
        }
        
        /* Для плавного исчезновения баннера */
        #messageBanner {
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1 class="text-3xl font-extrabold text-white mb-6">TashBoss Clicker</h1>
        
        <!-- Баннер сообщений (не alert) -->
        <div id="messageBanner" class="hidden transition duration-500 ease-in-out opacity-100" style="display: none;"></div>

        <!-- Статус загрузки / Ошибка -->
        <div id="statusMessage" class="card text-lg text-yellow-400">Инициализация WebApp...</div>

        <!-- Основной контент игры -->
        <div id="gameContent" class="hidden">
            
            <!-- Дисплей Баланса -->
            <div class="card bg-gray-900/50 p-6">
                <p class="text-gray-400 text-sm">Ваш текущий баланс (BossCoin):</p>
                <!-- Добавляем ID пользователя для отладки -->
                <p class="text-xs text-gray-500 mb-2">UID: <span id="userIdDisplay">...</span></p>
                
                <div class="balance-display" id="balanceDisplay">0.00</div>
                <p class="text-gray-400 text-xs mt-2" id="passiveIncomeDisplay">Пассивный доход/сек: 0.00</p>
            </div>
            
            <!-- Сбор Дохода -->
            <div class="card bg-gray-800 p-4">
                <button id="collectIncomeButton" class="w-full py-3 px-4 bg-yellow-500 text-gray-900 font-bold rounded-lg shadow-lg hover:bg-yellow-600 transition duration-200" disabled>
                    Собрать доход (0.00 BC)
                </button>
            </div>

            <!-- Секция Покупки Секторов -->
            <div class="mt-6">
                <h2 class="text-xl font-bold mb-4 text-left">Купить Сектора</h2>
                <div id="sectorsContainer">
                    <!-- Карточки секторов будут добавлены JavaScript из app.js -->
                </div>
            </div>
            
            <p id="timer-status" class="text-xs text-gray-500 mt-4"></p>
        </div>
    </div>

    <!-- Подключение Логики -->
    <script type="module" src="./app.js"></script>
    <script type="module">
        // --- Скрипт Инициализации Firebase и Аутентификации ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, getIdToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Глобальные Настройки ---
        // ИСПРАВЛЕНО: Project ID должен соответствовать ключу сервисного аккаунта.
        const firebaseConfig = { projectId: "tashboss-1bd35" }; 
        const API_BASE_URL = window.location.origin;

        // --- DOM Элементы ---
        const statusMessage = document.getElementById('statusMessage');

        // Включаем логирование Firebase
        setLogLevel('debug');


        /**
         * 1. Надежно получает ID пользователя Telegram.
         * @returns {string | null}
         */
        function getTelegramUserId() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe.user) {
                // Возвращаем ID в виде строки, как требует Firebase Auth
                return window.Telegram.WebApp.initDataUnsafe.user.id.toString();
            }
            console.error("Telegram WebApp SDK user data not found.");
            statusMessage.classList.add('text-red-500');
            statusMessage.textContent = "❌ Ошибка: Приложение должно быть запущено внутри Telegram.";
            return null;
        }

        /**
         * 2. Запрашивает Firebase Custom Token у бэкенда.
         */
        async function fetchInitialIdToken() {
            try {
                statusMessage.textContent = "Инициализация Firebase (шаг 2/3)...";
                const app = initializeApp(firebaseConfig);
                const authClient = getAuth(app);
                
                statusMessage.textContent = "Вход в систему (шаг 3/3 - Анонимно)...";
                
                // Вход анонимно для получения UID, который мы затем будем использовать в API
                const userCredential = await authClient.signInAnonymously();
                
                const userUID = userCredential.user.uid;
                console.log(`✅ Успешный анонимный вход в Firebase. UID: ${userUID}`);
                
                // Получаем ID Token, который будем использовать для всех запросов к API
                const idToken = await userCredential.user.getIdToken();

                // Вызываем глобальную функцию в app.js для запуска основной логики игры
                if (window.initAppAfterAuth) {
                    window.initAppAfterAuth(idToken, userUID);
                } else {
                    console.error("initAppAfterAuth is not defined in app.js.");
                }
                
                // Скрываем статус и показываем контент
                statusMessage.classList.add('hidden');
                
                // Показываем кнопку закрытия Telegram WebApp
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.MainButton.setText("Закрыть игру").show().onClick(() => {
                    window.Telegram.WebApp.close();
                });
                
            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                // Это может быть причиной 404, если токен не получен
                statusMessage.textContent = `Ошибка: Не удалось войти в Firebase. Пожалуйста, проверьте консоль.`;
                statusMessage.classList.remove('hidden');
            }
        }
        
        // --- Главная функция инициализации ---
        async function main() {
            await fetchInitialIdToken();
        }
        
        // Запускаем приложение при загрузке DOM
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
