<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .app-container {
            max-width: 480px;
            height: 100vh;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .header-gradient {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        .sector-card {
            transition: transform 0.1s;
        }
        .sector-card:active {
            transform: scale(0.98);
        }
        .btn-collect {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            transition: all 0.2s;
        }
        .btn-collect:hover {
             box-shadow: 0 4px 10px rgba(16, 185, 129, 0.5);
        }
        .btn-buy {
            background-color: #3b82f6;
            transition: all 0.2s;
        }
        .btn-buy:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –±–∞–ª–∞–Ω—Å -->
        <header class="header-gradient text-white p-4 rounded-b-xl shadow-lg">
            <h1 class="text-2xl font-extrabold text-center">TashBoss Clicker</h1>
            <div class="flex justify-between items-center mt-2">
                <div class="flex flex-col items-center">
                    <p class="text-sm opacity-80">–ë–∞–ª–∞–Ω—Å (BSS)</p>
                    <p id="balance" class="text-4xl font-black text-yellow-300">0.00</p>
                </div>
                <div class="flex flex-col items-end">
                    <p class="text-sm opacity-80">–î–æ—Ö–æ–¥/—Å–µ–∫</p>
                    <p id="income-rate" class="text-xl font-bold text-green-400">0.00</p>
                </div>
            </div>
        </header>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ -->
        <div id="status-message" class="p-4 text-center text-sm font-semibold text-gray-600 bg-yellow-100 rounded-lg m-4 hidden">
            –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±–æ—Ä–∞ –¥–æ—Ö–æ–¥–∞ -->
        <div class="p-4">
            <button id="collect-button" class="btn-collect w-full py-3 text-lg font-bold text-white rounded-xl shadow-md disabled:opacity-50" disabled>
                –°–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥ (<span id="collectable-amount">0.00</span> BSS)
            </button>
        </div>

        <!-- –°–µ–∫—Ç–æ—Ä—ã (–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º–∞—è –æ–±–ª–∞—Å—Ç—å) -->
        <main class="flex-1 overflow-y-auto p-4 space-y-4">
            <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">–°–µ–∫—Ç–æ—Ä—ã –ì–æ—Ä–æ–¥–∞</h2>
            
            <!-- –°–µ–∫—Ç–æ—Ä 1: –ü–∞—Ä–∫–∏ -->
            <div id="sector1-card" class="sector-card bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-2xl">üå≥</span>
                    <h3 class="text-lg font-bold text-gray-900">–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞</h3>
                    <p class="text-sm text-gray-500">–î–æ—Ö–æ–¥: <span class="income-rate-val">0.5</span> BSS/—Å–µ–∫</p>
                </div>
                <p class="text-xs text-gray-500 mb-3">–ü–∞—Ä–∫–∏ –∏ —Å–∫–≤–µ—Ä—ã –¥–ª—è –∂–∏—Ç–µ–ª–µ–π.</p>
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <span class="text-lg font-extrabold" id="sector1-level">–£—Ä. 0</span>
                        <span class="text-xs text-gray-500" id="sector1-count">0 —à—Ç.</span>
                    </div>
                    <button data-sector="sector1" class="btn-buy buy-button text-white px-4 py-2 rounded-lg font-semibold text-sm disabled:bg-gray-400">
                        –ö—É–ø–∏—Ç—å –∑–∞ <span id="sector1-cost">100.00</span>
                    </button>
                </div>
            </div>
            
            <!-- –°–µ–∫—Ç–æ—Ä 2: –û—Ñ–∏—Å—ã -->
            <div id="sector2-card" class="sector-card bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-2xl">üè¢</span>
                    <h3 class="text-lg font-bold text-gray-900">–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä</h3>
                    <p class="text-sm text-gray-500">–î–æ—Ö–æ–¥: <span class="income-rate-val">2.0</span> BSS/—Å–µ–∫</p>
                </div>
                <p class="text-xs text-gray-500 mb-3">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –ø–ª–æ—â–∞–¥–∏ –∏ –∫–æ–≤–æ—Ä–∫–∏–Ω–≥–∏.</p>
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <span class="text-lg font-extrabold" id="sector2-level">–£—Ä. 0</span>
                        <span class="text-xs text-gray-500" id="sector2-count">0 —à—Ç.</span>
                    </div>
                    <button data-sector="sector2" class="btn-buy buy-button text-white px-4 py-2 rounded-lg font-semibold text-sm disabled:bg-gray-400">
                        –ö—É–ø–∏—Ç—å –∑–∞ <span id="sector2-cost">500.00</span>
                    </button>
                </div>
            </div>

            <!-- –°–µ–∫—Ç–æ—Ä 3: –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ -->
            <div id="sector3-card" class="sector-card bg-white p-4 rounded-xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-2xl">üè≠</span>
                    <h3 class="text-lg font-bold text-gray-900">–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞</h3>
                    <p class="text-sm text-gray-500">–î–æ—Ö–æ–¥: <span class="income-rate-val">10.0</span> BSS/—Å–µ–∫</p>
                </div>
                <p class="text-xs text-gray-500 mb-3">–ö—Ä—É–ø–Ω—ã–µ –∑–∞–≤–æ–¥—ã –∏ —Å–∫–ª–∞–¥—ã.</p>
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <span class="text-lg font-extrabold" id="sector3-level">–£—Ä. 0</span>
                        <span class="text-xs text-gray-500" id="sector3-count">0 —à—Ç.</span>
                    </div>
                    <button data-sector="sector3" class="btn-buy buy-button text-white px-4 py-2 rounded-lg font-semibold text-sm disabled:bg-gray-400">
                        –ö—É–ø–∏—Ç—å –∑–∞ <span id="sector3-cost">2500.00</span>
                    </button>
                </div>
            </div>

            <!-- –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è) -->
            <div class="mt-8 pt-4 border-t text-xs text-gray-400">
                <p>‚ö†Ô∏è –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–∞–≥–ª—É—à–∫–∞ user ID.</p>
                <p>–ë—ç–∫–µ–Ω–¥ —Å—Ç–∞—Ç—É—Å: <span id="backend-status" class="text-red-500">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></p>
            </div>

        </main>
    </div>

    <script>
        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∑–∞–≥–ª—É—à–∫–∏ user ID, —Ç–∞–∫ –∫–∞–∫ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –æ–Ω–∞ —Ç–∞–∫–∂–µ –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω–∞
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è Telegram Init Data –∏ –≤—ã–∑–æ–≤ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è UID
        const USER_ID = "test_user_for_debug"; 
        const BASE_API_URL = ""; // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å—ã –∏–¥—É—Ç –Ω–∞ —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç
        
        let currentState = {
            balance: 0.0,
            sectors: { "sector1": 0, "sector2": 0, "sector3": 0 },
            last_collection_time: new Date().toISOString()
        };

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ (–î–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å api.py) ---
        const INCOME_RATES = {
            "sector1": 0.5, 
            "sector2": 2.0, 
            "sector3": 10.0
        };
        const SECTOR_COSTS = {
            "sector1": 100.0, 
            "sector2": 500.0, 
            "sector3": 2500.0
        };
        const COST_MULTIPLIER = 1.15;
        const SECTOR_TITLES = {
            "sector1": "–ó–æ–Ω–∞ –æ—Ç–¥—ã—Ö–∞", 
            "sector2": "–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä", 
            "sector3": "–ò–Ω–¥—É—Å—Ç—Ä–∏–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞"
        };
        // --------------------------------------------------------
        
        // DOM Elements
        const balanceEl = document.getElementById('balance');
        const incomeRateEl = document.getElementById('income-rate');
        const collectButton = document.getElementById('collect-button');
        const collectableAmountEl = document.getElementById('collectable-amount');
        const statusMessageEl = document.getElementById('status-message');
        const buyButtons = document.querySelectorAll('.buy-button');
        const backendStatusEl = document.getElementById('backend-status');

        let isPolling = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –æ–ø—Ä–æ—Å–æ–≤

        /**
         * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–∞
         * @param {number} num 
         * @returns {string}
         */
        function formatNumber(num) {
            return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        /**
         * –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–µ–∫—Ç–æ—Ä–∞ –ø–æ —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—É–ª–µ
         * @param {string} sectorName 
         * @param {number} currentLevel 
         * @returns {number}
         */
        function calculateCost(sectorName, currentLevel) {
            const baseCost = SECTOR_COSTS[sectorName];
            const cost = baseCost * Math.pow(COST_MULTIPLIER, currentLevel);
            return Math.round(cost * 100) / 100; // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
        }

        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
         */
        function updateUI() {
            let totalIncome = 0;
            
            // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ç–æ—Ä–æ–≤ –∏ —Ä–∞—Å—á–µ—Ç –æ–±—â–µ–≥–æ –¥–æ—Ö–æ–¥–∞
            for (const sector in currentState.sectors) {
                const level = currentState.sectors[sector];
                const count = level; // –£—Ä–æ–≤–µ–Ω—å = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ç–æ—Ä–æ–≤
                const rate = INCOME_RATES[sector];
                const cost = calculateCost(sector, level);

                totalIncome += rate * count;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–µ–∫—Ç–æ—Ä–∞
                const levelEl = document.getElementById(`${sector}-level`);
                const countEl = document.getElementById(`${sector}-count`);
                const costEl = document.getElementById(`${sector}-cost`);
                const buyButton = document.querySelector(`.buy-button[data-sector="${sector}"]`);

                if (levelEl) levelEl.textContent = `–£—Ä. ${level}`;
                if (countEl) countEl.textContent = `${count} —à—Ç.`;
                if (costEl) costEl.textContent = formatNumber(cost);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏
                if (buyButton) {
                    const isAffordable = currentState.balance >= cost;
                    buyButton.disabled = !isAffordable;
                    if (isAffordable) {
                        buyButton.classList.remove('disabled:bg-gray-400');
                        buyButton.classList.add('btn-buy');
                    } else {
                        buyButton.classList.add('disabled:bg-gray-400');
                        buyButton.classList.remove('btn-buy');
                    }
                }
            }

            // 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞
            balanceEl.textContent = formatNumber(currentState.balance);
            incomeRateEl.textContent = formatNumber(totalIncome);

            // 3. –†–∞—Å—á–µ—Ç —Å–æ–±–∏—Ä–∞–µ–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞
            calculateCollectableAmount();
        }

        /**
         * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—É–º–º—É, –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–ª—è —Å–±–æ—Ä–∞.
         */
        function calculateCollectableAmount() {
            let totalIncome = 0;
            for (const sector in currentState.sectors) {
                totalIncome += INCOME_RATES[sector] * currentState.sectors[sector];
            }

            try {
                const lastTime = new Date(currentState.last_collection_time);
                const now = new Date();
                const deltaSeconds = (now.getTime() - lastTime.getTime()) / 1000;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–±–æ—Ä–∞ 10 –¥–Ω—è–º–∏ (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –±—ç–∫–µ–Ω–¥–æ–º)
                const MAX_IDLE_TIME = 10 * 24 * 3600;
                const effectiveSeconds = Math.min(deltaSeconds, MAX_IDLE_TIME);

                const collectable = totalIncome * effectiveSeconds;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–±–æ—Ä–∞
                collectableAmountEl.textContent = formatNumber(collectable);
                collectButton.disabled = (collectable < 0.01 && totalIncome === 0);

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–æ–±–∏—Ä–∞–µ–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞:", e);
                collectableAmountEl.textContent = "0.00";
                collectButton.disabled = true;
            }
        }

        /**
         * –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è Fetch –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
         * @param {string} endpoint 
         * @param {object} options 
         * @returns {Promise<object>}
         */
        async function apiFetch(endpoint, options = {}) {
            try {
                statusMessageEl.classList.remove('hidden');
                statusMessageEl.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...';

                const response = await fetch(`${BASE_API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // –ó–¥–µ—Å—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ Authorization —Å Init Data
                        'Authorization': `Bearer ${USER_ID}` 
                    },
                    ...options
                });

                const data = await response.json();

                if (!response.ok) {
                    const message = data.detail || `–û—à–∏–±–∫–∞: ${response.status} ${response.statusText}`;
                    statusMessageEl.textContent = `‚ùå –û—à–∏–±–∫–∞ API: ${message}`;
                    throw new Error(message);
                }
                
                statusMessageEl.textContent = '‚úÖ –£—Å–ø–µ—à–Ω–æ.';
                setTimeout(() => statusMessageEl.classList.add('hidden'), 1000);
                
                return data;
            } catch (error) {
                console.error(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ ${endpoint}:`, error);
                statusMessageEl.textContent = `‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`;
                setTimeout(() => statusMessageEl.classList.add('hidden'), 5000);
                throw error;
            }
        }


        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–°–æ–±—Ä–∞—Ç—å –¥–æ—Ö–æ–¥".
         */
        async function handleCollectIncome() {
            if (isPolling) return; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–±–æ—Ä–∞ –∏ –ø–æ–∫—É–ø–∫–∏
            
            try {
                const data = await apiFetch('/api/collect_income');
                if (data.status === 'ok') {
                    currentState = data.state;
                    updateUI();
                }
            } catch (e) {
                // –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ apiFetch
            }
        }

        /**
         * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å —Å–µ–∫—Ç–æ—Ä".
         * @param {Event} event 
         */
        async function handleBuySector(event) {
            const button = event.currentTarget;
            const sector = button.dataset.sector;
            
            if (button.disabled || isPolling) return;
            
            button.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞

            try {
                const data = await apiFetch('/api/buy_sector', {
                    body: JSON.stringify({ sector: sector })
                });

                if (data.status === 'ok') {
                    currentState = data.state;
                    updateUI();
                }
            } catch (e) {
                // –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ apiFetch
            } finally {
                // –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –∫–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –≤ updateUI —á–µ—Ä–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫—É –±–∞–ª–∞–Ω—Å–∞
                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, updateUI –æ–±–Ω–æ–≤–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç/—Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–Ω–æ–ø–∫–∏
                updateUI(); 
            }
        }
        
        // --- –ó–ê–ü–£–°–ö –ò–ì–†–´ ---

        /**
         * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
         */
        async function initGame() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±—ç–∫–µ–Ω–¥–∞
            try {
                const debugResponse = await fetch(`${BASE_API_URL}/api/debug_info`);
                const debugData = await debugResponse.json();
                
                if (debugData.status === 'ok_ready') {
                    backendStatusEl.textContent = 'OK (Firestore –¥–æ—Å—Ç—É–ø–µ–Ω)';
                    backendStatusEl.classList.remove('text-red-500');
                    backendStatusEl.classList.add('text-green-500');
                } else {
                    backendStatusEl.textContent = `–û—à–∏–±–∫–∞: ${debugData.db_check_result}`;
                    backendStatusEl.classList.add('text-red-500');
                }
            } catch (e) {
                 backendStatusEl.textContent = '–ù–µ—Ç —Å–≤—è–∑–∏ —Å API';
                 backendStatusEl.classList.add('text-red-500');
            }


            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            statusMessageEl.classList.remove('hidden');
            statusMessageEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã...';
            
            try {
                const data = await apiFetch('/api/load_state');
                if (data.status === 'ok') {
                    currentState = data.state;
                    updateUI();
                    
                    // 3. –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±–∏—Ä–∞–µ–º–æ–≥–æ –¥–æ—Ö–æ–¥–∞
                    isPolling = true;
                    setInterval(calculateCollectableAmount, 1000);
                }
            } catch (e) {
                // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ - –∏–≥—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–∞
                statusMessageEl.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
            }

            // 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            collectButton.addEventListener('click', handleCollectIncome);
            buyButtons.forEach(button => {
                button.addEventListener('click', handleBuySector);
            });
        }

        window.onload = initGame;
    </script>
</body>
</html>
