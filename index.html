<!DOCTYPE html>
<html lang="ru">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>TashBoss Mini App</title>
Â  Â  <!-- Tailwind CSS CDN -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <!-- Inter Font -->
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
Â  Â  <!-- Telegram Mini App Script -->
Â  Â  <script src="https://telegram.org/js/telegram-web-app.js"></script>
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --tg-theme-bg-color: #f7f7f7;
Â  Â  Â  Â  Â  Â  --tg-theme-text-color: #000000;
Â  Â  Â  Â  }
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: var(--tg-theme-bg-color, #f7f7f7);
Â  Â  Â  Â  Â  Â  color: var(--tg-theme-text-color, #000000);
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s, color 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Dark Mode support for Telegram theme */
Â  Â  Â  Â  @media (prefers-color-scheme: dark) {
Â  Â  Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  Â  Â  background-color: var(--tg-theme-bg-color, #1a1a1a);
Â  Â  Â  Â  Â  Â  Â  Â  color: var(--tg-theme-text-color, #ffffff);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  .app-container {
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-card {
Â  Â  Â  Â  Â  Â  background-color: var(--tg-theme-secondary-bg-color, #e0e0e0);
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--tg-theme-hint-color, #aaaaaa);
Â  Â  Â  Â  }
Â  Â  Â  Â  .industry-card {
Â  Â  Â  Â  Â  Â  background-color: var(--tg-theme-secondary-bg-color, #e0e0e0);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary {
Â  Â  Â  Â  Â  Â  background-color: var(--tg-theme-button-color, #007bff);
Â  Â  Â  Â  Â  Â  color: var(--tg-theme-button-text-color, #ffffff);
Â  Â  Â  Â  Â  Â  transition: transform 0.1s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-primary:active {
Â  Â  Â  Â  Â  Â  transform: scale(0.98);
Â  Â  Â  Â  }
Â  Â  Â  Â  .pulse-animation {
Â  Â  Â  Â  Â  Â  animation: pulse 1.5s infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes pulse {
Â  Â  Â  Â  Â  Â  0%, 100% { opacity: 1; }
Â  Â  Â  Â  Â  Â  50% { opacity: 0.7; }
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div class="app-container">
Â  Â  <!-- Header: Score and Production -->
Â  Â  <!-- Ğ˜ĞĞ”Ğ˜ĞšĞĞ¢ĞĞ  Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ˜: Ğ”Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğ¼ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ -->
Â  Â  <div id="loading-indicator" class="text-center py-10">
Â  Â  Â  Â  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-tg-theme-text-color mx-auto"></div>
Â  Â  Â  Â  <p class="mt-4 text-tg-theme-hint-color">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...</p>
Â  Â  </div>

Â  Â  <!-- ĞĞ¡ĞĞĞ’ĞĞĞ• Ğ¡ĞĞ”Ğ•Ğ Ğ–ĞĞĞ˜Ğ•: Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ¾ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ -->
Â  Â  <div id="main-content" class="hidden space-y-6">
Â  Â  Â  Â  <div class="header-card p-4 rounded-xl shadow-lg">
Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-extrabold mb-2 text-tg-theme-text-color">TashBoss ğŸ—ï¸</h1>
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-tg-theme-hint-color">Ğ’Ğ°Ğ»ÑÑ‚Ğ° (BSS)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="player-score" class="text-4xl font-black text-tg-theme-text-color">0</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-tg-theme-hint-color text-right">ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ (Ğ´Ğ¾Ñ…Ğ¾Ğ´/Ñ†Ğ¸ĞºĞ»)</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="total-production" class="text-2xl font-bold text-green-500 text-right">0</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Accumulated Profit and Collect Button -->
Â  Â  Â  Â  Â  Â  <div id="collect-area" class="bg-yellow-500/10 p-3 rounded-lg flex justify-between items-center transition-all duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-yellow-500 mr-2 text-lg">ğŸ’°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-tg-theme-text-color">ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¾: <span id="accumulated-profit-display" class="font-bold text-lg">0</span> BSS</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="collect-button" onclick="collectProfit()" class="btn-primary px-4 py-2 text-sm font-bold rounded-full transition-transform duration-100 disabled:opacity-50" disabled>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <!-- User ID for Debugging/Sharing -->
Â  Â  Â  Â  Â  Â  <p class="text-xs text-tg-theme-hint-color mt-3">Ğ’Ğ°Ñˆ ID: <span id="user-id-display"></span></p>

Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- My Industries Section -->
Â  Â  Â  Â  <section>
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-3 mt-4 text-tg-theme-text-color">ĞœĞ¾Ğ¸ ĞÑ‚Ñ€Ğ°ÑĞ»Ğ¸</h2>
Â  Â  Â  Â  Â  Â  <div id="owned-industries-list" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Owned industries cards will be injected here -->
Â  Â  Â  Â  Â  Â  Â  Â  <p id="no-industries-msg" class="text-tg-theme-hint-color text-sm">Ğ£ Ğ²Ğ°Ñ Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ĞºÑƒĞ¿Ğ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¾Ñ‚Ñ€Ğ°ÑĞ»ĞµĞ¹. ĞšÑƒĞ¿Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾-Ğ½Ğ¸Ğ±ÑƒĞ´ÑŒ Ğ½Ğ¸Ğ¶Ğµ!</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <!-- Available Industries Section -->
Â  Â  Â  Â  <section>
Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold mb-3 mt-6 text-tg-theme-text-color">Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ¸</h2>
Â  Â  Â  Â  Â  Â  <div id="available-industries-list" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Available industries cards will be injected here -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  </div>

Â  Â  <!-- Message Box (replaces alert/confirm) -->
Â  Â  <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
Â  Â  Â  Â  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
Â  Â  Â  Â  Â  Â  <h3 id="message-title" class="text-lg font-bold text-tg-theme-text-color">Ğ£ÑĞ¿ĞµÑ…</h3>
Â  Â  Â  Â  Â  Â  <p id="message-body" class="text-sm text-tg-theme-text-color"></p>
Â  Â  Â  Â  Â  Â  <button onclick="document.getElementById('message-box').classList.add('hidden'); document.getElementById('message-box').classList.remove('flex');" class="btn-primary w-full py-2 rounded-lg font-semibold">
Â  Â  Â  Â  Â  Â  Â  Â  Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  // Constants and Global State
Â  Â  const BASE_URL = window.location.origin; // Dynamically use the current host
Â  Â  // Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğº API (30 ÑĞµĞºÑƒĞ½Ğ´, Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ "Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ€Ñ‚Ğ°" Render)
Â  Â  const API_TIMEOUT_MS = 30000;Â 

Â  Â  let userId = null;
Â  Â  let playerState = {};
Â  Â  let masterData = [];
Â  Â  let accumulationLoopInterval = null;

Â  Â  // ĞĞĞ’ĞĞ•: Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ (Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸)
Â  Â  let visualAccumulationState = {
Â  Â  Â  Â  profit: 0,
Â  Â  Â  Â  lastUpdateTime: 0,
Â  Â  Â  Â  productionPerSecond: 0,
Â  Â  };

Â  Â  // --- UTILITIES ---

Â  Â  /**
Â  Â  Â * Helper function to safely get an element by ID.
Â  Â  Â * @param {string} id The element ID.
Â  Â  Â * @returns {HTMLElement | null}
Â  Â  Â */
Â  Â  function getEl(id) {
Â  Â  Â  Â  return document.getElementById(id);
Â  Â  }

Â  Â  /**
Â  Â  Â * Shows a custom message box instead of alert.
Â  Â  Â * @param {string} titleÂ 
Â  Â  Â * @param {string} bodyÂ 
Â  Â  Â */
Â  Â  function showMessage(title, body) {
Â  Â  Â  Â  const msgBox = getEl('message-box');
Â  Â  Â  Â  if (msgBox) {
Â  Â  Â  Â  Â  Â  getEl('message-title').textContent = title;
Â  Â  Â  Â  Â  Â  getEl('message-body').textContent = body;
Â  Â  Â  Â  Â  Â  msgBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  msgBox.classList.add('flex');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error('Message box element not found!');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Handles API calls with exponential backoff and timeout.
Â  Â  Â * @param {string} endpointÂ 
Â  Â  Â * @param {string} methodÂ 
Â  Â  Â * @param {Object} bodyÂ 
Â  Â  Â * @param {number} retriesÂ 
Â  Â  Â * @returns {Promise<Object>}
Â  Â  Â */
Â  Â  async function fetchWithRetry(endpoint, method = 'GET', body = null, retries = 3) {
Â  Â  Â  Â  // Ğ£Ğ±ĞµĞ´Ğ¸Ğ¼ÑÑ, Ñ‡Ñ‚Ğ¾ BASE_URL Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ HTTPS, ĞµÑĞ»Ğ¸ Ğ¼Ñ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ÑÑ Ğ½Ğ° Render
Â  Â  Â  Â  let url = `${BASE_URL}${endpoint}`;
Â  Â  Â  Â  if (url.startsWith('http://tashboss.onrender.com')) {
Â  Â  Â  Â  Â  Â  url = url.replace('http:', 'https:');
Â  Â  Â  Â  }

Â  Â  Â  Â  for (let i = 0; i < retries; i++) {
Â  Â  Â  Â  Â  Â  const controller = new AbortController();
Â  Â  Â  Â  Â  Â  const timeoutId = setTimeout(() => controller.abort(), API_TIMEOUT_MS);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: method,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  signal: controller.signal // Add the signal for timeout
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  if (body) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  options.body = JSON.stringify(body);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url, options);
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // If it's a 4xx or 5xx error, but not a network error, throw it for handling
Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ detail: 'Unknown error or non-JSON response' }));
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(errorData.detail || `HTTP Error: ${response.status} ${response.statusText}`);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(timeoutId);

Â  Â  Â  Â  Â  Â  Â  Â  // Handle AbortError specifically (our timeout)
Â  Â  Â  Â  Â  Â  Â  Â  if (error.name === 'AbortError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  error.message = "Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ. Ğ¡ĞµÑ€Ğ²ĞµÑ€ (Render) Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ ÑĞ½Ğ°. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºÑƒ.";
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${i + 1} failed for ${url}:`, error);
Â  Â  Â  Â  Â  Â  Â  Â  if (i === retries - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw error;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- GAME LOGIC (ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ) ---

Â  Â  /**
Â  Â  Â * Visual accumulation loop (client-side only for smooth UX).
Â  Â  Â * Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ†Ğ¸ĞºĞ» Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ñ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… playerState.
Â  Â  Â */
Â  Â  function startAccumulationLoop() {
Â  Â  Â  Â  if (accumulationLoopInterval) {
Â  Â  Â  Â  Â  Â  clearInterval(accumulationLoopInterval);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 1. Ğ’Ñ‹Ñ‡Ğ¸ÑĞ»ÑĞµĞ¼ Ğ½Ğ¾Ğ²ÑƒÑ ÑÑƒĞ¼Ğ¼Ğ°Ñ€Ğ½ÑƒÑ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ° (Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ)
Â  Â  Â  Â  let totalProductionPerSecond = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  playerState.industries.forEach(ownedInd => {
Â  Â  Â  Â  Â  Â  const masterInd = masterData.find(m => m.id === ownedInd.id);
Â  Â  Â  Â  Â  Â  if (masterInd && masterInd.cycle_time_sec > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // Income per cycle / Cycle time = Income per second
Â  Â  Â  Â  Â  Â  Â  Â  const incomePerSecond = (masterInd.base_income * ownedInd.level) / masterInd.cycle_time_sec;
Â  Â  Â  Â  Â  Â  Â  Â  totalProductionPerSecond += incomePerSecond;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // 2. Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼/Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞµÑ€Ğ²ĞµÑ€Ğ°
Â  Â  Â  Â  visualAccumulationState.productionPerSecond = totalProductionPerSecond;
Â  Â  Â  Â  visualAccumulationState.profit = playerState.accumulated_profit || 0;
Â  Â  Â  Â  visualAccumulationState.lastUpdateTime = Date.now(); // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ¹Ğ¼ĞµÑ€
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾ Ğ·Ğ° Ñ†Ğ¸ĞºĞ» (Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ, Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½Ğ¾Ğµ Ñ Ğ±ÑĞºĞµĞ½Ğ´Ğ°)
Â  Â  Â  Â  const totalProductionEl = getEl('total-production');
Â  Â  Â  Â  if (totalProductionEl) totalProductionEl.textContent = playerState.total_production.toLocaleString('ru-RU');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 3. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
Â  Â  Â  Â  accumulationLoopInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  Â  // Ğ’Ñ€ĞµĞ¼Ñ, Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞµ Ñ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, Ğ² ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ…
Â  Â  Â  Â  Â  Â  const timePassed = (now - visualAccumulationState.lastUpdateTime) / 1000; 
Â  Â  Â  Â  Â  Â  visualAccumulationState.lastUpdateTime = now; // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ

Â  Â  Â  Â  Â  Â  if (visualAccumulationState.productionPerSecond > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  // ĞĞ°ĞºĞ°Ğ¿Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ñƒ Ğ¸ Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞµĞ³Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸
Â  Â  Â  Â  Â  Â  Â  Â  visualAccumulationState.profit += visualAccumulationState.productionPerSecond * timePassed;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const profitInt = Math.floor(visualAccumulationState.profit);
Â  Â  Â  Â  Â  Â  const profitDisplayEl = getEl('accumulated-profit-display');
Â  Â  Â  Â  Â  Â  const collectBtn = getEl('collect-button');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (profitDisplayEl) profitDisplayEl.textContent = profitInt.toLocaleString('ru-RU');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (collectBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  if (profitInt > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  collectBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  collectBtn.classList.add('pulse-animation');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  collectBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  collectBtn.classList.remove('pulse-animation');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 200); // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 200 Ğ¼Ñ Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
Â  Â  }

Â  Â  /**
Â  Â  Â * Collects accumulated profit by calling the /update API.
Â  Â  Â */
Â  Â  async function collectProfit() {
Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  showMessage("ĞÑˆĞ¸Ğ±ĞºĞ°", "Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const collectBtn = getEl('collect-button');
Â  Â  Â  Â  if (collectBtn) {
Â  Â  Â  Â  Â  Â  collectBtn.disabled = true;
Â  Â  Â  Â  Â  Â  collectBtn.textContent = 'Ğ¡Ğ±Ğ¾Ñ€...';
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = await fetchWithRetry(`/update/${userId}`, 'POST');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Ğ’ĞĞ–ĞĞ: ĞŸÑ€Ğ¸ ÑĞ±Ğ¾Ñ€Ğµ Ğ¾Ğ±Ğ½ÑƒĞ»ÑĞµĞ¼ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ´Ğ¾Ñ…Ğ¾Ğ´ Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº Ğ½Ğ°Ñ‡Ğ°Ğ» Ñ Ğ½ÑƒĞ»Ñ
Â  Â  Â  Â  Â  Â  playerState = { ...data, accumulated_profit: 0 }; 
Â  Â  Â  Â  Â  Â  renderUI();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ° Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸
Â  Â  Â  Â  Â  Â  startAccumulationLoop();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showMessage("Ğ£ÑĞ¿ĞµÑ…!", `Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ´Ğ¾Ñ…Ğ¾Ğ´. Ğ’Ğ°Ñˆ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ: ${playerState.score.toLocaleString('ru-RU')} BSS.`);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showMessage("ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ±Ğ¾Ñ€Ğ°", error.message);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  if (collectBtn) collectBtn.textContent = 'Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Buys an industry.
Â  Â  Â * @param {string} industryFrontendId The string ID (e.g., 'lemonade_stand')
Â  Â  Â */
Â  Â  async function buyIndustry(industryFrontendId) {
Â  Â  Â  Â  if (!userId) {
Â  Â  Â  Â  Â  Â  showMessage("ĞÑˆĞ¸Ğ±ĞºĞ°", "Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const industry = masterData.find(m => m.frontend_id === industryFrontendId);
Â  Â  Â  Â  if (!industry) {
Â  Â  Â  Â  Â  Â  showMessage("ĞÑˆĞ¸Ğ±ĞºĞ°", "ĞÑ‚Ñ€Ğ°ÑĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const btn = getEl(`buy-btn-${industryFrontendId}`);
Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.textContent = 'ĞŸĞ¾ĞºÑƒĞ¿ĞºĞ°...';
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = await fetchWithRetry(`/buy/${userId}/${industryFrontendId}`, 'POST');
Â  Â  Â  Â  Â  Â  playerState = { ...data };
Â  Â  Â  Â  Â  Â  renderUI();
Â  Â  Â  Â  Â  Â  // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ†Ğ¸ĞºĞ»Ğ° Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒÑ
Â  Â  Â  Â  Â  Â  startAccumulationLoop();
Â  Â  Â  Â  Â  Â  showMessage("ĞšÑƒĞ¿Ğ»ĞµĞ½Ğ¾!", `Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ĞºÑƒĞ¿Ğ¸Ğ»Ğ¸: ${industry.name}.`);
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  showMessage("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿ĞºĞ¸", error.message);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  if (btn) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = `ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ğ·Ğ° ${industry.base_cost.toLocaleString('ru-RU')} BSS`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- UI RENDERERS ---

Â  Â  /**
Â  Â  Â * Renders the current player score and total production rate.
Â  Â  Â */
Â  Â  function renderHeader() {
Â  Â  Â  Â  const playerScoreEl = getEl('player-score');
Â  Â  Â  Â  if (playerScoreEl) playerScoreEl.textContent = playerState.score.toLocaleString('ru-RU');
Â  Â  Â  Â  // Total production is updated and displayed in startAccumulationLoop
Â  Â  }

Â  Â  /**
Â  Â  Â * Renders the list of industries owned by the player.
Â  Â  Â */
Â  Â  function renderOwnedIndustries() {
Â  Â  Â  Â  const list = getEl('owned-industries-list');
Â  Â  Â  Â  if (!list) return;

Â  Â  Â  Â  list.innerHTML = ''; // Clear existing list
Â  Â  Â  Â  const noMsg = getEl('no-industries-msg');

Â  Â  Â  Â  if (playerState.industries && playerState.industries.length > 0) {
Â  Â  Â  Â  Â  Â  if (noMsg) noMsg.classList.add('hidden');
Â  Â  Â  Â  Â  Â  playerState.industries.forEach(ownedInd => {
Â  Â  Â  Â  Â  Â  Â  Â  const masterInd = masterData.find(m => m.id === ownedInd.id);
Â  Â  Â  Â  Â  Â  Â  Â  if (masterInd) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="industry-card p-3 rounded-lg shadow-md border-l-4 border-green-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg font-semibold">${masterInd.name} (Ğ£Ñ€. ${ownedInd.level})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-tg-theme-hint-color">${masterInd.description}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-bold text-green-500">+${(masterInd.base_income * ownedInd.level).toLocaleString('ru-RU')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-tg-theme-hint-color">Ğ·Ğ° ${masterInd.cycle_time_sec} ÑĞµĞº</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.insertAdjacentHTML('beforeend', html);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (noMsg) noMsg.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Renders the list of available industries for purchase.
Â  Â  Â */
Â  Â  function renderAvailableIndustries() {
Â  Â  Â  Â  const list = getEl('available-industries-list');
Â  Â  Â  Â  if (!list) return;

Â  Â  Â  Â  list.innerHTML = ''; // Clear existing list

Â  Â  Â  Â  // Get IDs of industries already owned (for filtering)
Â  Â  Â  Â  const ownedIds = playerState.industries.map(ind => ind.id);

Â  Â  Â  Â  masterData.forEach(industry => {
Â  Â  Â  Â  Â  Â  const isOwned = ownedIds.includes(industry.id);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!isOwned) {
Â  Â  Â  Â  Â  Â  Â  Â  const canAfford = playerState.score >= industry.base_cost;
Â  Â  Â  Â  Â  Â  Â  Â  const buttonClass = canAfford ? 'btn-primary' : 'bg-gray-400 text-gray-700 cursor-not-allowed';
Â  Â  Â  Â  Â  Â  Â  Â  const buttonDisabled = canAfford ? '' : 'disabled';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const html = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="industry-card p-4 rounded-xl shadow-md space-y-2 border-l-4 ${canAfford ? 'border-blue-500' : 'border-gray-400'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold">${industry.name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-bold text-tg-theme-text-color">Ğ”Ğ¾Ñ…Ğ¾Ğ´: ${industry.base_income.toLocaleString('ru-RU')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-tg-theme-hint-color">${industry.description}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="buy-btn-${industry.frontend_id}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onclick="buyIndustry('${industry.frontend_id}')"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full py-2 rounded-lg font-semibold ${buttonClass}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${buttonDisabled}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ğ·Ğ° ${industry.base_cost.toLocaleString('ru-RU')} BSS
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  list.insertAdjacentHTML('beforeend', html);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  /**
Â  Â  Â * Renders the entire UI based on the current playerState.
Â  Â  Â */
Â  Â  function renderUI() {
Â  Â  Â  Â  renderHeader();
Â  Â  Â  Â  renderOwnedIndustries();
Â  Â  Â  Â  renderAvailableIndustries();
Â  Â  Â  Â  // startAccumulationLoop is called separately after initial fetch and updates
Â  Â  Â  Â  Telegram.WebApp.ready();
Â  Â  }


Â  Â  // --- INITIALIZATION ---

Â  Â  async function initializeApp() {
Â  Â  Â  Â  const loadingIndicator = getEl('loading-indicator');
Â  Â  Â  Â  const mainContent = getEl('main-content');

Â  Â  Â  Â  if (loadingIndicator) loadingIndicator.classList.remove('hidden');
Â  Â  Â  Â  if (mainContent) mainContent.classList.add('hidden');

Â  Â  Â  Â  // 1. Check Telegram WebApp init
Â  Â  Â  Â  if (typeof Telegram === 'undefined' || !Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
Â  Â  Â  Â  Â  Â  // Fallback for local testing (use a static ID)
Â  Â  Â  Â  Â  Â  userId = 'test_user_12345';Â 
Â  Â  Â  Â  Â  Â  console.warn("Telegram WebApp not initialized. Using fallback user ID.");
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
Â  Â  Â  Â  Â  Â  // Set Telegram UI Theme
Â  Â  Â  Â  Â  Â  const theme = Telegram.WebApp.themeParams;
Â  Â  Â  Â  Â  Â  if (theme) {
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-bg-color', theme.bg_color || '#f7f7f7');
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-text-color', theme.text_color || '#000000');
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', theme.secondary_bg_color || '#e0e0e0');
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-hint-color', theme.hint_color || '#aaaaaa');
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-button-color', theme.button_color || '#007bff');
Â  Â  Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--tg-theme-button-text-color', theme.button_text_color || '#ffffff');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userIdDisplay = getEl('user-id-display');
Â  Â  Â  Â  if (userIdDisplay) userIdDisplay.textContent = userId;

Â  Â  Â  Â  // 2. Fetch data
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Fetch Master Data
Â  Â  Â  Â  Â  Â  masterData = await fetchWithRetry('/master-data');
Â  Â  Â  Â  Â  Â  // Fetch Player State (includes initial accumulated profit)
Â  Â  Â  Â  Â  Â  playerState = await fetchWithRetry(`/state/${userId}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Render and start loops
Â  Â  Â  Â  Â  Â  renderUI();
Â  Â  Â  Â  Â  Â  startAccumulationLoop();

Â  Â  Â  Â  Â  Â  // 4. Show content (Safely hide/show)
Â  Â  Â  Â  Â  Â  if (loadingIndicator) loadingIndicator.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (mainContent) mainContent.classList.remove('hidden');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 5. Setup Telegram closing button (optional but good practice)
Â  Â  Â  Â  Â  Â  Telegram.WebApp.ready();
Â  Â  Â  Â  Â  Â  Telegram.WebApp.MainButton.setText("Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ˜Ğ³Ñ€Ñƒ");
Â  Â  Â  Â  Â  Â  Telegram.WebApp.MainButton.show();
Â  Â  Â  Â  Â  Â  Telegram.WebApp.MainButton.onClick(() => Telegram.WebApp.close());

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Initialization failed:", error);
Â  Â  Â  Â  Â  Â  // Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
Â  Â  Â  Â  Â  Â  let errorMessage = error.message;
Â  Â  Â  Â  Â  Â  if (errorMessage.includes("Failed to fetch") || errorMessage.includes("Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚") || error.name === 'AbortError') {
Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = `Ğ¡ĞµÑ€Ğ²ĞµÑ€ Render ÑĞ¿Ğ¸Ñ‚ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¿Ğ¾Ğ´Ğ¾Ğ¶Ğ´Ğ¸Ñ‚Ğµ 30 ÑĞµĞºÑƒĞ½Ğ´ Ğ¸ Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ. ĞÑˆĞ¸Ğ±ĞºĞ°: ${error.name || 'Network Error'}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (loadingIndicator) {
Â  Â  Â  Â  Â  Â  Â  Â  loadingIndicator.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-red-500 font-bold">ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ API</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-tg-theme-hint-color mt-2 p-2 rounded-lg bg-red-500/10 text-sm">${errorMessage}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="initializeApp()" class="btn-primary mt-4 px-4 py-2 rounded-lg">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºÑƒ</button>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¼, Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¾Ğ¹
Â  Â  Â  Â  Â  Â  if (mainContent) mainContent.classList.add('hidden');

Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Export functions to global scope so they can be called from HTML
Â  Â  window.collectProfit = collectProfit;
Â  Â  window.buyIndustry = buyIndustry;

Â  Â  // Start the application after the document is loaded
Â  Â  window.onload = initializeApp;

</script>
</body>
</html>
