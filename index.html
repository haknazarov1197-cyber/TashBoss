<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss: –ú–∏–Ω–∏-–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind –¥–ª—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ —Ü–≤–µ—Ç–æ–≤
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0a5b8f', // –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π
                        'secondary': '#10a08e', // –ë–∏—Ä—é–∑–æ–≤—ã–π
                        'background': '#1f2937', // –¢–µ–º–Ω—ã–π —Ñ–æ–Ω
                        'card-bg': '#374151', // –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
            color: #f3f4f6;
            min-height: 100vh;
        }
        .card {
            background-color: #374151;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #10b981; /* –ó–µ–ª–µ–Ω—ã–π */
            color: white;
            transition: background-color 0.1s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #059669;
        }
        .btn-secondary {
            background-color: #3b82f6; /* –°–∏–Ω–∏–π */
            color: white;
            transition: background-color 0.1s;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-tertiary {
            background-color: #f59e0b; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ */
            color: white;
            transition: background-color 0.1s;
        }
        .btn-tertiary:hover:not(:disabled) {
            background-color: #d97706;
        }
        .btn-disabled {
            background-color: #4b5563;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .income-ready {
            border: 2px solid #10b981;
            animation: pulse-green 1.5s infinite;
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 pb-20">
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <div id="loading" class="text-center p-12 text-gray-400">
        <svg class="animate-spin h-8 w-8 text-secondary mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö TashBoss...
    </div>

    <div id="app-content" class="hidden max-w-2xl mx-auto">
        
        <!-- HEADER / BALANCE -->
        <header class="text-center mb-6 p-4 rounded-xl bg-card-bg shadow-lg">
            <h1 class="text-3xl font-bold text-secondary">TashBoss</h1>
            <p class="text-sm text-gray-400 mt-1">–°–∏–º—É–ª—è—Ç–æ—Ä –≥—Ä–∞–¥–æ–Ω–∞—á–∞–ª—å–Ω–∏–∫–∞</p>
            <div class="mt-3">
                <p class="text-xl font-semibold">üí∞ –ë–∞–ª–∞–Ω—Å: <span id="player-balance">0</span> BSS</p>
            </div>
            <div class="mt-4 p-2 bg-gray-600 rounded-lg">
                <h2 class="text-lg font-medium">–û–±—â–∏–π –¥–æ—Ö–æ–¥ –∫ —Å–±–æ—Ä—É: <span id="total-income">0</span> BSS</h2>
            </div>
        </header>

        <!-- SECTORS LIST -->
        <main id="sectors-container" class="space-y-4"></main>
        
    </div>

    <!-- MAIN JAVASCRIPT LOGIC -->
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        
        let USER_ID = null;
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            USER_ID = tg.initDataUnsafe.user.id;
        } else {
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ Telegram (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
            USER_ID = 'TEST_USER_12345'; 
            console.warn("Using TEST_USER_ID. Run inside Telegram Web App for real user ID.");
        }

        // –í–ê–ñ–ù–û: URL –≤–∞—à–µ–≥–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ FastAPI —Å–µ—Ä–≤–µ—Ä–∞
        const BASE_API_URL = window.location.origin;

        let gameState = {
            balance: 0,
            industries: {}
        };
        let updateInterval = null;

        // --- API HELPERS ---
        async function apiFetch(endpoint, method = 'GET', body = null) {
            const url = `${BASE_API_URL}/api/${endpoint}`;
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (endpoint !== 'load_state' && method !== 'GET') {
                    tg.showProgress();
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: body ? JSON.stringify(body) : null,
                });

                tg.hideProgress();

                if (!response.ok) {
                    const errorData = await response.json();
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—à–∏–±–∫–∏ "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BSS"
                    const detail = errorData.detail || `Server error: ${response.status}`;
                    tg.showAlert(`–û—à–∏–±–∫–∞: ${detail}`);
                    throw new Error(detail);
                }
                return await response.json();
            } catch (error) {
                tg.hideProgress();
                console.error("API Fetch Error:", error.message);
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ response.ok
                return null;
            }
        }
        
        // --- GAME LOGIC FUNCTIONS ---

        function formatTime(seconds) {
            if (seconds <= 0) return '–ì–æ—Ç–æ–≤–æ!';
            
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;

            let result = '';
            if (mins > 0) {
                result += `${mins} –º–∏–Ω. `;
            }
            result += `${secs} —Å–µ–∫.`;
            return result.trim();
        }

        function renderSector(key, sectorData) {
            const container = document.getElementById('sectors-container');
            const sectorElement = document.getElementById(`sector-${key}`) || document.createElement('div');
            sectorElement.id = `sector-${key}`;
            
            const level = sectorData.level;
            const isOwned = level > 0;
            const isManaged = sectorData.is_managed; // –ù–æ–≤–æ–µ –ø–æ–ª–µ
            const nextCost = sectorData.cost;
            const income = sectorData.income;
            const managerCost = sectorData.manager_cost; // –ù–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            
            // –ï—Å–ª–∏ –¥–æ—Ö–æ–¥ –≥–æ—Ç–æ–≤ –∏ –Ω–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º
            const isReadyToCollect = sectorData.income_to_collect > 0 && !isManaged;
            sectorElement.className = `card p-4 rounded-xl ${isReadyToCollect ? 'income-ready' : ''}`;
            
            const config = sectorData.config; 
            
            let statusHTML = '';
            let buttonsHTML = '';
            let managerHTML = '';

            if (isManaged) {
                managerHTML = '<span class="text-sm font-semibold text-primary bg-yellow-300 px-2 py-0.5 rounded-full">‚úÖ –ê–í–¢–û–°–ë–û–†</span>';
            } else if (isOwned) {
                 managerHTML = `
                    <button class="btn-tertiary w-full mt-2 p-2 rounded-lg font-semibold text-sm" 
                            onclick="hireManager('${key}', ${managerCost})"
                            ${gameState.balance < managerCost ? 'disabled' : ''}>
                        üë§ –ù–∞–Ω—è—Ç—å –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ (${managerCost.toLocaleString()} BSS)
                    </button>
                `;
            }
            
            if (isOwned) {
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
                const remaining = Math.max(0, sectorData.current_cycle_time - (Date.now() / 1000 - sectorData.last_collect) % sectorData.current_cycle_time);
                
                statusHTML = `
                    <div class="flex justify-between items-center">
                        <p class="text-lg font-bold text-secondary">${config.name} (–£—Ä. ${level})</p>
                        ${managerHTML}
                    </div>
                    <p class="text-sm text-gray-300">üí∞ –ü—Ä–∏–±—ã–ª—å –∑–∞ —Ü–∏–∫–ª: ${income.toLocaleString()} BSS</p>
                    <div class="mt-2 text-md">
                        <p class="text-yellow-300">–ù–∞–∫–æ–ø–ª–µ–Ω–æ: ${sectorData.income_to_collect.toLocaleString()} BSS</p>
                        <p class="text-gray-400" id="timer-${key}">
                            ${isManaged ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä' : formatTime(Math.ceil(remaining))}
                        </p>
                    </div>
                `;

                // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
                buttonsHTML = `
                    <button class="btn-primary w-full sm:w-1/2 p-2 rounded-lg font-semibold" 
                            onclick="collectIncome('${key}')"
                            ${sectorData.income_to_collect === 0 || isManaged ? 'disabled' : ''}>
                        üì• –°–æ–±—Ä–∞—Ç—å
                    </button>
                    <button class="btn-secondary w-full sm:w-1/2 p-2 rounded-lg font-semibold ml-0 sm:ml-2 mt-2 sm:mt-0" 
                            onclick="upgradeSector('${key}')"
                            ${gameState.balance < nextCost ? 'disabled' : ''}>
                        üöÄ –£–ª—É—á—à–∏—Ç—å (${nextCost.toLocaleString()} BSS)
                    </button>
                `;
            } else {
                // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–µ–∫—É–ø–ª–µ–Ω–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞
                statusHTML = `
                    <p class="text-lg font-bold text-secondary">${config.name} (–ù–µ –∫—É–ø–ª–µ–Ω)</p>
                    <p class="text-sm text-gray-300">–ë–∞–∑–æ–≤–∞—è –ø—Ä–∏–±—ã–ª—å: ${income.toLocaleString()} BSS</p>
                    <p class="text-sm text-gray-300">–í—Ä–µ–º—è —Ü–∏–∫–ª–∞: ${sectorData.current_cycle_time} —Å–µ–∫.</p>
                `;

                buttonsHTML = `
                    <button class="btn-primary w-full p-2 rounded-lg font-semibold" 
                            onclick="upgradeSector('${key}', true)"
                            ${gameState.balance < nextCost ? 'disabled' : ''}>
                        üõí –ö—É–ø–∏—Ç—å (${nextCost.toLocaleString()} BSS)
                    </button>
                `;
            }

            sectorElement.innerHTML = `
                ${statusHTML}
                ${isOwned && !isManaged ? managerHTML : ''}
                <div class="mt-4 flex flex-col sm:flex-row justify-between">
                    ${buttonsHTML}
                </div>
            `;
            
            if (!document.getElementById(`sector-${key}`)) {
                container.appendChild(sectorElement);
            }
        }

        function updateUI() {
            let totalIncome = 0;
            const sortedKeys = Object.keys(gameState.industries).sort();
            
            // 1. Render Sectors
            sortedKeys.forEach(key => {
                const sectorData = gameState.industries[key];
                // –£—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Ö–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –í–†–£–ß–ù–£–Æ (—Ç.–µ. –±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä–∞)
                if (sectorData.level > 0 && !sectorData.is_managed) {
                    totalIncome += sectorData.income_to_collect || 0;
                }
                renderSector(key, sectorData);
            });
            
            // 2. Update Main Headers
            document.getElementById('player-balance').textContent = gameState.balance.toLocaleString();
            document.getElementById('total-income').textContent = totalIncome.toLocaleString();

            // 3. Update Telegram MainButton
            if (totalIncome > 0) {
                tg.MainButton.setText(`üì• –°–æ–±—Ä–∞—Ç—å –í–ï–°–¨ –¥–æ—Ö–æ–¥ (${totalIncome.toLocaleString()} BSS)`).show().enable();
                tg.MainButton.onClick(collectAllIncome);
            } else {
                tg.MainButton.hide();
            }

            // 4. Show Content
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
        }
        
        // --- API CALLS ---

        async function loadGameState() {
            if (!USER_ID) return;
            
            // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º—ã –∏–º–∏—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª—è–µ–º—ã—Ö —Å–µ–∫—Ç–æ—Ä–æ–≤
            const data = await apiFetch(`load_state?user_id=${USER_ID}`);
            
            if (data) {
                gameState = data;
                
                // –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –∑–∞–ø—É—â–µ–Ω
                if (updateInterval === null) {
                    updateInterval = setInterval(updateLocalTimers, 1000);
                }
                
                updateUI();
            }
        }

        async function collectIncome(sectorKey) {
            const body = { user_id: USER_ID, sector_key: sectorKey };
            const result = await apiFetch('collect_income', 'POST', body);
            if (result) {
                tg.showNotification({ message: `‚úÖ –°–æ–±—Ä–∞–Ω–æ: ${result.collected_income.toLocaleString()} BSS!`, type: 'success' });
                await loadGameState();
            }
        }

        async function collectAllIncome() {
            const body = { user_id: USER_ID };
            
            const result = await apiFetch('collect_all_income', 'POST', body);
            
            if (result && result.total_collected_income > 0) {
                tg.showNotification({ message: `‚úÖ –û–±—â–∏–π –¥–æ—Ö–æ–¥ —Å–æ–±—Ä–∞–Ω: ${result.total_collected_income.toLocaleString()} BSS!`, type: 'success' });
                await loadGameState();
            } else if (result) {
                 tg.showAlert('–ù–µ—Ç –≥–æ—Ç–æ–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞ –¥–ª—è —Å–±–æ—Ä–∞ –≤—Ä—É—á–Ω—É—é.');
            }
        }

        async function upgradeSector(sectorKey, isPurchase = false) {
            const body = { user_id: USER_ID, sector_key: sectorKey };
            const result = await apiFetch('upgrade_sector', 'POST', body);
            
            if (result) {
                let message = isPurchase 
                    ? `üéâ –°–µ–∫—Ç–æ—Ä –∫—É–ø–ª–µ–Ω! –í–∞—à —É—Ä–æ–≤–µ–Ω—å: 1.`
                    : `üöÄ –£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –¢–µ–ø–µ—Ä—å —É—Ä–æ–≤–µ–Ω—å: ${result.new_level}.`;
                
                tg.showNotification({ message: message, type: 'success' });
                await loadGameState();
            }
        }
        
        async function hireManager(sectorKey, cost) {
            tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –Ω–∞–Ω—è—Ç—å –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞ ${cost.toLocaleString()} BSS? –û–Ω –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—Ç—å –¥–æ—Ö–æ–¥.`, async (confirmed) => {
                if (confirmed) {
                    const body = { user_id: USER_ID, sector_key: sectorKey };
                    const result = await apiFetch('hire_manager', 'POST', body);
                    
                    if (result) {
                        tg.showNotification({ message: `‚úÖ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–Ω—è—Ç! –°–±–æ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω.`, type: 'success' });
                        await loadGameState();
                    }
                }
            });
        }

        // --- LOCAL TIMER LOGIC ---
        // –û–±–Ω–æ–≤–ª—è–µ—Ç UI –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
        function updateLocalTimers() {
            const currentTimestamp = Date.now() / 1000;
            let totalIncomeManual = 0;

            Object.keys(gameState.industries).forEach(key => {
                const sectorData = gameState.industries[key];
                
                if (sectorData.level > 0) {
                    
                    const isManaged = sectorData.is_managed;
                    const elapsed = currentTimestamp - sectorData.last_collect;
                    const cycleTime = sectorData.current_cycle_time;
                    const incomePerCycle = sectorData.income; 
                    
                    const cyclesCompleted = Math.floor(elapsed / cycleTime);
                    const incomeToCollect = cyclesCompleted * incomePerCycle;
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞
                    sectorData.income_to_collect = incomeToCollect;

                    if (!isManaged) {
                        totalIncomeManual += incomeToCollect;
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ –∏ –∫–Ω–æ–ø–æ–∫
                    const timerElement = document.getElementById(`timer-${key}`);
                    const collectButton = document.querySelector(`#sector-${key} button:first-child`);
                    const cardElement = document.getElementById(`sector-${key}`);

                    if (isManaged) {
                        if (timerElement) timerElement.textContent = '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä';
                        if (collectButton) collectButton.disabled = true;
                        if (cardElement) cardElement.classList.remove('income-ready');
                    } else {
                        // –î–ª—è —Ä—É—á–Ω–æ–≥–æ —Å–±–æ—Ä–∞
                        const remaining = Math.ceil(cycleTime - (elapsed % cycleTime));
                        if (timerElement) {
                            timerElement.textContent = formatTime(remaining);
                        }
                        
                        if (collectButton) {
                            collectButton.disabled = incomeToCollect === 0;
                        }
                        
                        if (cardElement) {
                            if (incomeToCollect > 0) {
                                cardElement.classList.add('income-ready');
                            } else {
                                cardElement.classList.remove('income-ready');
                            }
                        }
                    }
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ –∏ –∫–Ω–æ–ø–∫–∏
            document.getElementById('total-income').textContent = totalIncomeManual.toLocaleString();

            if (totalIncomeManual > 0) {
                tg.MainButton.setText(`üì• –°–æ–±—Ä–∞—Ç—å –í–ï–°–¨ –¥–æ—Ö–æ–¥ (${totalIncomeManual.toLocaleString()} BSS)`).show().enable();
                tg.MainButton.onClick(collectAllIncome);
            } else {
                tg.MainButton.hide();
            }
        }

        // --- INIT ---
        tg.onEvent('main_button_pressed', collectAllIncome);
        loadGameState();
    </script>
</body>
</html>
