<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #ffffff;
            transition: background-color 0.3s, color 0.3s;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è Telegram Theming */
        :root {
            --tg-theme-bg-color: #0d1117;
            --tg-theme-text-color: #ffffff;
            --tg-theme-button-color: #4CAF50;
            --tg-theme-button-text-color: #ffffff;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="app-container w-full max-w-md mx-auto">
        <header class="w-full text-center py-6">
            <h1 class="text-4xl font-bold text-green-400">TashBoss üèôÔ∏è</h1>
            <p class="text-lg text-gray-400 mt-2">–°–∏–º—É–ª—è—Ç–æ—Ä –ì–æ—Ä–æ–¥—Å–∫–æ–≥–æ –ë–æ—Å—Å–∞</p>
        </header>

        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
        <main class="w-full bg-gray-800 p-6 rounded-xl shadow-2xl space-y-6">
            
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞–ª–∞–Ω—Å–∞ -->
            <div class="p-4 bg-gray-700 rounded-lg flex justify-between items-center shadow-inner">
                <span class="text-lg font-medium">–ë–∞–ª–∞–Ω—Å BSS:</span>
                <span id="balance" class="text-3xl font-extrabold text-yellow-300">0.00</span>
            </div>

            <!-- –†–∞–∑–¥–µ–ª –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞ -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold border-b border-gray-600 pb-2">–î–æ—Ö–æ–¥ –∏ –°–±–æ—Ä</h2>
                
                <div class="flex flex-col space-y-2">
                    <button id="collect-button" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition duration-150 transform hover:scale-[1.01] active:scale-[0.99]">
                        –°–æ–±—Ä–∞—Ç—å –ü–∞—Å—Å–∏–≤–Ω—ã–π –î–æ—Ö–æ–¥
                    </button>
                    <p id="collected-info" class="text-sm text-center text-gray-400 h-5"></p>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª –ø–æ–∫—É–ø–∫–∏ —Å–µ–∫—Ç–æ—Ä–æ–≤ -->
            <div class="space-y-4">
                <h2 class="text-2xl font-semibold border-b border-gray-600 pb-2">–ü–æ–∫—É–ø–∫–∞ –°–µ–∫—Ç–æ—Ä–æ–≤</h2>
                
                <div id="sectors-list" class="space-y-3">
                    <!-- –°–µ–∫—Ç–æ—Ä 1 -->
                    <div id="sector1-card" class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg">–ö–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –ö–æ–º–ø–ª–µ–∫—Å (0)</p>
                            <p class="text-sm text-gray-400">–î–æ—Ö–æ–¥: 0.5 BSS/—Å–µ–∫</p>
                        </div>
                        <button data-sector="sector1" data-cost="100.0" class="buy-button py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition duration-150 active:scale-95">
                            –ö—É–ø–∏—Ç—å (100)
                        </button>
                    </div>
                    
                    <!-- –°–µ–∫—Ç–æ—Ä 2 -->
                    <div id="sector2-card" class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg">–¢–æ—Ä–≥–æ–≤—ã–π –¶–µ–Ω—Ç—Ä (0)</p>
                            <p class="text-sm text-gray-400">–î–æ—Ö–æ–¥: 2.0 BSS/—Å–µ–∫</p>
                        </div>
                        <button data-sector="sector2" data-cost="500.0" class="buy-button py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition duration-150 active:scale-95">
                            –ö—É–ø–∏—Ç—å (500)
                        </button>
                    </div>

                    <!-- –°–µ–∫—Ç–æ—Ä 3 -->
                    <div id="sector3-card" class="bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg">–ë–∏–∑–Ω–µ—Å-–°–∏—Ç–∏ (0)</p>
                            <p class="text-sm text-gray-400">–î–æ—Ö–æ–¥: 10.0 BSS/—Å–µ–∫</p>
                        </div>
                        <button data-sector="sector3" data-cost="2500.0" class="buy-button py-2 px-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition duration-150 active:scale-95">
                            –ö—É–ø–∏—Ç—å (2500)
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ/–∑–∞–≥—Ä—É–∑–∫–µ -->
            <p id="message-box" class="text-center text-red-400 font-medium h-6"></p>

        </main>
        
        <footer class="mt-8 text-sm text-gray-500">
            <p>User ID: <span id="user-id">...</span></p>
            <p>Auth: <span id="auth-status">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
        </footer>
    </div>

    <!-- JavaScript –¥–ª—è –ª–æ–≥–∏–∫–∏ Mini App -->
    <script>
        const API_BASE_URL = window.location.origin; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–º–µ–Ω –¥–ª—è API
        let AUTH_TOKEN = null;
        let USER_ID = 'unknown';

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const balanceEl = document.getElementById('balance');
        const collectButton = document.getElementById('collect-button');
        const collectedInfoEl = document.getElementById('collected-info');
        const messageBox = document.getElementById('message-box');
        const userIdEl = document.getElementById('user-id');
        const authStatusEl = document.getElementById('auth-status');
        
        const SECTOR_INFO = {
            sector1: { name: "–ö–≤–∞—Ä—Ç–∏—Ä–Ω—ã–π –ö–æ–º–ø–ª–µ–∫—Å", rate: 0.5, cost: 100.0 },
            sector2: { name: "–¢–æ—Ä–≥–æ–≤—ã–π –¶–µ–Ω—Ç—Ä", rate: 2.0, cost: 500.0 },
            sector3: { name: "–ë–∏–∑–Ω–µ—Å-–°–∏—Ç–∏", rate: 10.0, cost: 2500.0 },
        };

        // --- –£—Ç–∏–ª–∏—Ç—ã UI ---

        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.className = `text-center font-medium h-6 ${isError ? 'text-red-400' : 'text-green-400'}`;
            setTimeout(() => { messageBox.textContent = ''; }, 3000);
        }

        function updateUI(state) {
            balanceEl.textContent = state.balance.toFixed(2);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏ –∏ —Å—á–µ—Ç—á–∏–∫–æ–≤
            Object.keys(SECTOR_INFO).forEach(sectorKey => {
                const count = state.sectors[sectorKey] || 0;
                const cost = SECTOR_INFO[sectorKey].cost * (count + 1);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è/—Å—á–µ—Ç—á–∏–∫–∞
                const cardEl = document.getElementById(`${sectorKey}-card`);
                cardEl.querySelector('.font-bold').textContent = `${SECTOR_INFO[sectorKey].name} (${count})`;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                const buyButton = cardEl.querySelector('.buy-button');
                buyButton.textContent = `–ö—É–ø–∏—Ç—å (${cost.toFixed(0)})`;
                buyButton.dataset.cost = cost;
                
                // –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è, –µ—Å–ª–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –±–∞–ª–∞–Ω—Å–∞
                if (state.balance < cost) {
                    buyButton.disabled = true;
                    buyButton.classList.add('opacity-50', 'cursor-not-allowed');
                    buyButton.classList.remove('hover:bg-blue-600');
                } else {
                    buyButton.disabled = false;
                    buyButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    buyButton.classList.add('hover:bg-blue-600');
                }
            });
        }

        // --- API –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ ---

        async function fetchAPI(endpoint, data = {}) {
            if (!AUTH_TOKEN) {
                showMessage("–û—à–∏–±–∫–∞: –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.", true);
                throw new Error("No auth token.");
            }

            const url = `${API_BASE_URL}/api/${endpoint}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${AUTH_TOKEN}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (!response.ok) {
                    showMessage(result.detail || "–û—à–∏–±–∫–∞ API", true);
                    throw new Error(result.detail || "API Error");
                }
                return result;
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                showMessage("–°–±–æ–π —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.", true);
                throw error;
            }
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ò–≥—Ä—ã ---

        async function loadState() {
            try {
                const result = await fetchAPI('load_state');
                updateUI(result.state);
                if (result.collected_income > 0.01) {
                    collectedInfoEl.textContent = `–°–æ–±—Ä–∞–Ω–æ: ${result.collected_income.toFixed(2)} BSS (AFK)`;
                } else {
                    collectedInfoEl.textContent = '';
                }
                return result.state;
            } catch (e) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã.");
                return null;
            }
        }

        async function collectIncome() {
            collectButton.disabled = true;
            collectButton.textContent = '–°–±–æ—Ä...';
            try {
                const result = await fetchAPI('collect_income');
                updateUI(result.state);
                showMessage(`–°–æ–±—Ä–∞–Ω–æ ${result.collected_income.toFixed(2)} BSS!`, false);
            } catch (e) {
                // –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ fetchAPI
            } finally {
                collectButton.disabled = false;
                collectButton.textContent = '–°–æ–±—Ä–∞—Ç—å –ü–∞—Å—Å–∏–≤–Ω—ã–π –î–æ—Ö–æ–¥';
                collectedInfoEl.textContent = ''; // –û—á–∏—â–∞–µ–º AFK –¥–æ—Ö–æ–¥ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∞
            }
        }
        
        async function buySector(sector) {
            const buyButton = document.querySelector(`.buy-button[data-sector="${sector}"]`);
            if (!buyButton) return;
            
            const originalText = buyButton.textContent;
            buyButton.disabled = true;
            buyButton.textContent = '–ü–æ–∫—É–ø–∫–∞...';

            try {
                const result = await fetchAPI('buy_sector', { sector: sector });
                updateUI(result.state);
                showMessage(`–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω ${SECTOR_INFO[sector].name}!`, false);
            } catch (e) {
                // –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ fetchAPI
            } finally {
                buyButton.disabled = false;
                buyButton.textContent = originalText;
                loadState(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∏ AFK –¥–æ—Ö–æ–¥–∞
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

        function initListeners() {
            collectButton.addEventListener('click', collectIncome);
            document.querySelectorAll('.buy-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    buySector(e.currentTarget.dataset.sector);
                });
            });
        }
        
        function initTelegram() {
            if (window.Telegram && window.Telegram.WebApp) {
                const WebApp = window.Telegram.WebApp;
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–∞
                WebApp.setHeaderColor('#16a34a'); // –ó–µ–ª–µ–Ω—ã–π
                WebApp.setBackgroundColor('#0d1117'); // –¢–µ–º–Ω—ã–π
                WebApp.ready();
                
                // –ü–æ–ª—É—á–µ–Ω–∏–µ initData
                const initData = WebApp.initData;
                if (initData) {
                    AUTH_TOKEN = initData; // –ò—Å–ø–æ–ª—å–∑—É–µ–º initData –∫–∞–∫ —Ç–æ–∫–µ–Ω
                    authStatusEl.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ';
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º mock user_id –∏–∑ WebApp.initDataUnsafe –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    if (WebApp.initDataUnsafe && WebApp.initDataUnsafe.user) {
                        USER_ID = WebApp.initDataUnsafe.user.id || 'N/A';
                    } else if (WebApp.initDataUnsafe) {
                        // –ï—Å–ª–∏ –Ω–µ—Ç user, –Ω–æ –µ—Å—Ç—å initDataUnsafe (–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è)
                        USER_ID = 'MockID';
                    }
                    userIdEl.textContent = USER_ID;

                    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
                    loadState(); 
                    initListeners();
                } else {
                    authStatusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ—Ç initData';
                    showMessage("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ –±–æ—Ç.", true);
                }
            } else {
                authStatusEl.textContent = '–û—à–∏–±–∫–∞: –ù–µ—Ç SDK';
                showMessage("Telegram WebApp SDK –Ω–µ –Ω–∞–π–¥–µ–Ω.", true);
                
                // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
                AUTH_TOKEN = "debug_token_123";
                USER_ID = "DEBUG-123";
                userIdEl.textContent = USER_ID;
                loadState();
                initListeners();
            }
        }

        window.onload = initTelegram;
    </script>
</body>
</html>
