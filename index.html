<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–∞ Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ–Ω–∞ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .game-container {
            max-width: 420px;
            width: 100%;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            padding: 1.5rem;
            border: 4px solid #3b82f6;
            /* –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É —Å–∫—Ä—ã—Ç–æ–π, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ */
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .click-button {
            transition: all 0.1s;
            box-shadow: 0 4px 0 0 #1e40af;
        }
        .click-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 0 #1e40af;
        }
        .buy-button {
            transition: all 0.2s;
        }
        .buy-button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .buy-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: #6b7280;
            box-shadow: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞ */
        #full-screen-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ffffff; /* –ë–µ–ª—ã–π —Ñ–æ–Ω –≤–º–µ—Å—Ç–æ —á–µ—Ä–Ω–æ–≥–æ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }
        .loader-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–´–ô –ó–ê–ì–†–£–ó–ß–ò–ö -->
<div id="full-screen-loader">
    <div class="loader-spinner"></div>
    <p class="text-xl font-semibold text-gray-700">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...</p>
    <p class="text-sm text-gray-500 mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
</div>
<!-- –ö–û–ù–ï–¶ –ó–ê–ì–†–£–ó–ß–ò–ö–ê -->

<div id="game-app" class="game-container">
    <h1 class="text-4xl font-extrabold text-center text-blue-700 mb-6">TashBoss Clicker</h1>

    <!-- –ë–ª–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div class="bg-blue-50 p-4 rounded-xl mb-4 border border-blue-200">
        <p id="auth-status" class="text-sm font-semibold text-gray-700 mb-1">
            <span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2 animate-pulse"></span>
            <span id="auth-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è...</span>
        </p>
        <p id="user-id-display" class="text-xs text-gray-500 truncate" title="–í–∞—à ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            ID: <span id="user-id-value">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
        </p>
    </div>

    <!-- –ë–ª–æ–∫ —Å—á–µ—Ç–∞ -->
    <div class="bg-white p-6 rounded-xl border-2 border-indigo-500 mb-6 text-center shadow-lg">
        <p class="text-2xl text-gray-600 font-medium">BSS (–ë–∏–ª–µ—Ç—ã –Ω–∞ –°–æ—Ü–∏–∞–ª—å–Ω–æ–µ –°—á–∞—Å—Ç—å–µ):</p>
        <p id="score-display" class="text-6xl font-black text-indigo-700 mt-2">0</p>
        <p id="dps-display" class="text-md text-gray-500 mt-1">–î–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É (–î–í–°): 0</p>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –∫–ª–∏–∫–∞ -->
    <button id="click-button"
            class="click-button w-full bg-blue-500 text-white p-4 text-2xl font-bold rounded-xl mb-6 shadow-xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400"
            onclick="handleManualClick()" disabled>
        –¢–∫–Ω—É—Ç—å (BSS +1)
    </button>

    <!-- –†–∞–∑–¥–µ–ª –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ -->
    <div class="bg-gray-100 p-4 rounded-xl">
        <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2 border-gray-300">–ù–∞–µ–º–Ω—ã–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</h2>

        <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä 1: –£–±–æ—Ä–∫–∞ —É–ª–∏—Ü -->
        <div id="manager-1" class="flex justify-between items-center bg-white p-3 rounded-lg mb-2 shadow-md">
            <div>
                <p class="font-semibold text-lg">üßπ –£–±–æ—Ä–∫–∞ —É–ª–∏—Ü</p>
                <p class="text-sm text-gray-500">–î–æ—Ö–æ–¥: <span id="manager-1-dps">1</span> –î–í–°</p>
                <p class="text-sm text-gray-500">–£ –≤–∞—Å: <span id="manager-1-count">0</span></p>
            </div>
            <button id="buy-manager-1-button"
                    class="buy-button bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-green-600 disabled:bg-gray-500"
                    onclick="buyManager(1)" disabled>
                –ö—É–ø–∏—Ç—å (100 BSS)
            </button>
        </div>
        
        <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä 2: –†–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥ -->
        <div id="manager-2" class="flex justify-between items-center bg-white p-3 rounded-lg mb-2 shadow-md">
            <div>
                <p class="font-semibold text-lg">üöß –†–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥</p>
                <p class="text-sm text-gray-500">–î–æ—Ö–æ–¥: <span id="manager-2-dps">10</span> –î–í–°</p>
                <p class="text-sm text-gray-500">–£ –≤–∞—Å: <span id="manager-2-count">0</span></p>
            </div>
            <button id="buy-manager-2-button"
                    class="buy-button bg-green-500 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-green-600 disabled:bg-gray-500"
                    onclick="buyManager(2)" disabled>
                –ö—É–ø–∏—Ç—å (1,000 BSS)
            </button>
        </div>

    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π (–≤–º–µ—Å—Ç–æ alert) -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-600">–û—à–∏–±–∫–∞!</h3>
            <p id="modal-message" class="text-gray-700 mb-4">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BSS.</p>
            <button onclick="closeModal()" class="w-full bg-blue-500 text-white py-2 rounded-lg font-semibold hover:bg-blue-600">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<script type="module">
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–µ —Å—Ä–µ–¥–æ–π Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // –ò–º–ø–æ—Ä—Ç—ã Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, runTransaction, setLogLevel, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let app, db, auth;
    let userId = null;
    let isGameReady = false;
    let gameData = {
        score: 0,
        dps: 0,
        managers: {
            1: 0,
            2: 0
        }
    };
    
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    const MANAGER_CONFIG = {
        1: { name: "–£–±–æ—Ä–∫–∞ —É–ª–∏—Ü", baseCost: 100, baseDps: 1, countId: 'manager-1-count', buttonId: 'buy-manager-1-button', costText: '100 BSS' },
        2: { name: "–†–µ–º–æ–Ω—Ç –¥–æ—Ä–æ–≥", baseCost: 1000, baseDps: 10, countId: 'manager-2-count', buttonId: 'buy-manager-2-button', costText: '1,000 BSS' }
    };

    // UI —ç–ª–µ–º–µ–Ω—Ç—ã
    const gameApp = document.getElementById('game-app');
    const loader = document.getElementById('full-screen-loader');
    const scoreDisplay = document.getElementById('score-display');
    const dpsDisplay = document.getElementById('dps-display');
    const clickButton = document.getElementById('click-button');
    const authStatus = document.getElementById('auth-status');
    const authText = document.getElementById('auth-text');
    const userIdValue = document.getElementById('user-id-value');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function showModal(title, message, isError = true) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-title').className = isError ? 'text-xl font-bold mb-3 text-red-600' : 'text-xl font-bold mb-3 text-green-600';
        document.getElementById('modal-message').textContent = message;
        document.getElementById('message-modal').classList.remove('hidden');
        document.getElementById('message-modal').classList.add('flex');
        console.log(`[CLICKER] –ü–æ–∫–∞–∑–∞–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: ${title} - ${message}`);
    }

    function closeModal() {
        document.getElementById('message-modal').classList.add('hidden');
        document.getElementById('message-modal').classList.remove('flex');
    }

    /**
     * –ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–≥—Ä—É.
     */
    function finishLoading() {
        isGameReady = true;
        clickButton.disabled = false;
        
        // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
        loader.style.opacity = '0';
        loader.addEventListener('transitionend', () => {
            loader.style.display = 'none';
        }, { once: true });
        
        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        gameApp.style.opacity = '1';

        console.log("[GAME] –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—é! –ó–∞–≥—Ä—É–∑—á–∏–∫ —Å–∫—Ä—ã—Ç.");
    }


    /**
     * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.
     */
    async function initFirebase() {
        console.log("[FIREBASE] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase...");
        try {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ Firestore
            setLogLevel('debug');
            
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("[FIREBASE] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –ø—É—Å—Ç–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å.");
                authText.textContent = "–û—à–∏–±–∫–∞: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.";
                finishLoading(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –æ—à–∏–±–∫—É
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            console.log("[FIREBASE] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ Firestore –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã.");

            // –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log(`[FIREBASE] –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. UID: ${userId}`);
                    authText.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
                    authStatus.querySelector('span').classList.replace('bg-red-500', 'bg-green-500');
                    userIdValue.textContent = userId;
                    
                    // –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã
                    loadGameData();
                } else {
                    // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("[FIREBASE] –í—Ö–æ–¥ —Å Custom Token.");
                        } else {
                            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω, –≤—Ö–æ–¥ –∞–Ω–æ–Ω–∏–º–Ω–æ
                            await signInAnonymously(auth);
                            console.log("[FIREBASE] –ê–Ω–æ–Ω–∏–º–Ω—ã–π –≤—Ö–æ–¥.");
                        }
                    } catch (error) {
                        console.error("[FIREBASE] –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:", error);
                        authText.textContent = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞. –°–º. –∫–æ–Ω—Å–æ–ª—å.";
                        authStatus.querySelector('span').classList.replace('bg-red-500', 'bg-red-700');
                        finishLoading(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –æ—à–∏–±–∫—É
                    }
                }
            });

        } catch (error) {
            console.error("[FIREBASE] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
            authText.textContent = `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`;
            finishLoading(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –æ—à–∏–±–∫—É
        }
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã –∏–∑ Firestore –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç onSnapshot.
     */
    function loadGameData() {
        if (!db || !userId) {
            console.warn("[GAME] DB –∏–ª–∏ userId –Ω–µ –≥–æ—Ç–æ–≤—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
            return;
        }

        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData`, 'clickerState');
        
        console.log(`[GAME] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—É—Ç–∏: ${gameDocRef.path}`);

        // –°–ª—É—à–∞—Ç–µ–ª—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        onSnapshot(gameDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                gameData.score = data.score || 0;
                gameData.dps = data.dps || 0;
                gameData.managers = data.managers || { 1: 0, 2: 0 };
                console.log("[GAME] –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã. –°—á–µ—Ç:", gameData.score);
            } else {
                console.log("[GAME] –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.");
                // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                setDoc(gameDocRef, { 
                    score: 0, 
                    dps: 0, 
                    managers: { 1: 0, 2: 0 },
                    lastUpdate: serverTimestamp() 
                }, { merge: true }).catch(e => console.error("[FIREBASE] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:", e));
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            updateUI();
            
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞, –∑–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            if (!isGameReady) {
                finishLoading();
            }
        }, (error) => {
            console.error("[FIREBASE] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö onSnapshot:", error);
            authText.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –°–º. –∫–æ–Ω—Å–æ–ª—å.";
            finishLoading(); // –ó–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª –æ—à–∏–±–∫—É
        });
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
     */
    function updateUI() {
        scoreDisplay.textContent = formatNumber(gameData.score);
        dpsDisplay.textContent = `–î–æ—Ö–æ–¥ –≤ —Å–µ–∫—É–Ω–¥—É (–î–í–°): ${formatNumber(gameData.dps)}`;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
        for (const id in MANAGER_CONFIG) {
            const config = MANAGER_CONFIG[id];
            const count = gameData.managers[id] || 0;
            const cost = config.baseCost; // –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ —Ä–∞—Å—Ç–µ—Ç

            document.getElementById(config.countId).textContent = formatNumber(count);
            // document.getElementById(config.buttonId).textContent = `–ö—É–ø–∏—Ç—å (${config.costText})`; // –û—Å—Ç–∞–≤–∏–º —ç—Ç–æ —Å—Ç–∞—Ç–∏—á–Ω—ã–º
            
            // –í–∫–ª—é—á–∞–µ–º/–æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É
            const button = document.getElementById(config.buttonId);
            if (isGameReady) {
                button.disabled = gameData.score < cost;
            }
        }
    }
    
    /**
     * –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —á–∏—Å–ª–æ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ (–¥–ª—è –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª).
     */
    function formatNumber(num) {
        if (num === null || num === undefined) return '0';
        return num.toLocaleString('ru-RU', { maximumFractionDigits: 0 });
    }

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä—É—á–Ω–æ–π –∫–ª–∏–∫.
     */
    function handleManualClick() {
        if (!isGameReady) {
            showModal("–û—à–∏–±–∫–∞", "–ò–≥—Ä–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
            console.log("[CLICKER] –ü–æ–ø—ã—Ç–∫–∞ –∫–ª–∏–∫–∞ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∏–≥—Ä—ã.");
            return;
        }

        const amount = 1;
        gameData.score += amount;
        updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è –æ—Ç–∫–ª–∏–∫–∞
        updateScoreInFirestore(amount, 0).catch(e => console.error("[FIREBASE] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª–∏–∫–∞:", e));
        
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        scoreDisplay.classList.add('scale-110');
        setTimeout(() => scoreDisplay.classList.remove('scale-110'), 50);
    }
    
    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–∫—É–ø–∫—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
     */
    async function buyManager(managerId) {
        if (!isGameReady) {
            showModal("–û—à–∏–±–∫–∞", "–ò–≥—Ä–∞ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
            return;
        }
        
        const id = managerId.toString();
        const config = MANAGER_CONFIG[id];
        const cost = config.baseCost; // –°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫–∞ —Å—Ç–∞—Ç–∏—á–Ω–∞
        
        console.log(`[CLICKER] –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–∫—É–ø–∫–∏ ${config.name}. –¢–µ–∫—É—â–∏–π —Å—á–µ—Ç: ${gameData.score}, –¶–µ–Ω–∞: ${cost}`);

        if (gameData.score < cost) {
            showModal("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ BSS", `–î–ª—è –ø–æ–∫—É–ø–∫–∏ "${config.name}" —Ç—Ä–µ–±—É–µ—Ç—Å—è ${formatNumber(cost)} BSS.`);
            return;
        }

        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData`, 'clickerState');

        try {
            await runTransaction(db, async (transaction) => {
                const docSnapshot = await transaction.get(gameDocRef);
                if (!docSnapshot.exists()) {
                    throw "–î–æ–∫—É–º–µ–Ω—Ç –∏–≥—Ä–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!";
                }

                const currentData = docSnapshot.data();
                const currentScore = currentData.score || 0;
                const currentManagers = currentData.managers || { 1: 0, 2: 0 };

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—á–µ—Ç –µ—â–µ —Ä–∞–∑ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
                if ((currentData.score || 0) < cost) {
                    throw "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞).";
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                const newScore = (currentData.score || 0) - cost;
                const newDps = (currentData.dps || 0) + config.baseDps;
                const currentManagerCount = currentManagers[id] || 0;
                const newManagers = { ...currentManagers, [id]: currentManagerCount + 1 };
                
                // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                transaction.set(gameDocRef, {
                    score: newScore,
                    dps: newDps,
                    managers: newManagers,
                    lastUpdate: serverTimestamp()
                }, { merge: true });
                
                console.log(`[CLICKER] –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ ${config.name} –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`);
                showModal("–ü–æ–∫—É–ø–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!", `–í—ã —É—Å–ø–µ—à–Ω–æ –Ω–∞–Ω—è–ª–∏ "${config.name}". –í–∞—à –î–í–° —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ ${config.baseDps}.`, false);
            });
        } catch (e) {
            console.error("[FIREBASE] –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏:", e);
            const errorMessage = (typeof e === 'string') ? e : (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.');
            if (errorMessage.includes("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤")) {
                showModal("–û—à–∏–±–∫–∞", "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–ª–∏–∫–Ω—É—Ç—å –µ—â–µ.");
            } else {
                showModal("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è", `–ù–µ —É–¥–∞–ª–æ—Å—å –∫—É–ø–∏—Ç—å: ${errorMessage}`);
            }
        }
    }

    /**
     * –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—á–µ—Ç–∞ –∏ DPS –≤ Firestore (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–ª–∏–∫–æ–≤ –∏ DPS).
     */
    async function updateScoreInFirestore(scoreChange, dpsChange) {
        if (!db || !userId) return;

        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/gameData`, 'clickerState');

        try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º setDoc —Å merge: true, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            await setDoc(gameDocRef, {
                score: gameData.score, // –ú—ã —É–∂–µ –æ–±–Ω–æ–≤–∏–ª–∏ gameData –ª–æ–∫–∞–ª—å–Ω–æ
                dps: gameData.dps,
                managers: gameData.managers,
                lastUpdate: serverTimestamp()
            }, { merge: true });
        } catch (e) {
            console.error("[FIREBASE] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:", e);
        }
    }

    /**
     * –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª –∏–≥—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Ö–æ–¥–∞ (DPS).
     */
    function gameLoop() {
        if (isGameReady && gameData.dps > 0) {
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Ö–æ–¥ –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É
            const income = gameData.dps;
            gameData.score += income;
            updateUI(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firestore
            updateScoreInFirestore(income, 0).catch(e => console.error("[FIREBASE] –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è DPS:", e));
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(gameLoop, 1000); 
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        initFirebase();
        gameLoop(); // –ó–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª DPS
    };
</script>

</body>
</html>
