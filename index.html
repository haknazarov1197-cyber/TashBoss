<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TashBoss Clicker</title>
    <!-- –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π SDK Telegram WebApp –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #0a1829 0%, #1f2e46 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
        }

        #app {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            text-align: center;
        }

        .card {
            background-color: #1f2e46;
            border: 1px solid #3a4b62;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        #clickButton {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(145deg, #1b283d, #253853);
            color: white;
            font-size: 20px;
            font-weight: 900;
            border: 5px solid #4a90e2;
            box-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 20px auto;
            cursor: pointer;
            user-select: none;
        }
        #clickButton:active {
            transform: scale(0.95);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.8);
        }
        .tap-text {
            font-size: 24px;
            margin-bottom: 2px;
        }
        .reward-text {
            font-size: 14px;
            font-weight: 400;
            opacity: 0.8;
        }

        .balance-display {
            font-size: 4rem;
            font-weight: 900;
            color: #4a90e2;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }

        .sector-button {
            padding: 10px 15px;
            margin: 5px;
            border-radius: 8px;
            font-weight: 700;
            transition: background-color 0.2s, border 0.2s;
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1 class="text-3xl font-extrabold text-white mb-6">TashBoss Clicker</h1>

        <!-- –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ / –û—à–∏–±–∫–∞ -->
        <div id="statusMessage" class="card text-lg text-yellow-400">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp...</div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–≥—Ä—ã -->
        <div id="gameContent" class="hidden">
            <!-- –î–∏—Å–ø–ª–µ–π –ë–∞–ª–∞–Ω—Å–∞ -->
            <div class="card bg-gray-900/50 p-6">
                <p class="text-gray-400 text-sm">–í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å:</p>
                <!-- –î–æ–±–∞–≤–ª—è–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
                <p class="text-xs text-gray-500 mb-2">ID: <span id="userIdDisplay">...</span></p>
                
                <div class="balance-display" id="balanceDisplay">0</div>
                <p class="text-gray-400 text-xs mt-2">–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ö–ª–∏–∫–∞ -->
            <div id="clickButton" role="button">
                <span class="tap-text">TAP!</span>
                <span class="reward-text" id="clickRewardText"></span>
            </div>

            <!-- –í—ã–±–æ—Ä –°–µ–∫—Ç–æ—Ä–∞ -->
            <div class="card mt-6">
                <h2 class="text-xl font-bold mb-4">–í—ã–±–æ—Ä –°–µ–∫—Ç–æ—Ä–∞ –ú–∞–π–Ω–∏–Ω–≥–∞</h2>
                <div id="sectorButtons" class="flex justify-center flex-wrap gap-2">
                    <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase –∏ –∏–≥—Ä—ã
        let db;
        let auth;
        let userId = null;
        let currentBalance = 0;
        let currentSectorKey = "sector1";
        const API_BASE_URL = window.location.origin;
        
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ–∫—Ç–æ—Ä–æ–≤ (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –±—ç–∫–µ–Ω–¥–æ–º)
        const SECTORS_CONFIG = {
            "sector1": {"name": "–°–µ–∫—Ç–æ—Ä A", "click_value": 1},
            "sector2": {"name": "–°–µ–∫—Ç–æ—Ä B", "click_value": 5},
            appId: "tashboss-clicker-app" // ID –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø—É—Ç–∏ Firestore
        };

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const statusMessage = document.getElementById('statusMessage');
        const gameContent = document.getElementById('gameContent');
        const balanceDisplay = document.getElementById('balanceDisplay');
        const clickButton = document.getElementById('clickButton');
        const clickRewardText = document.getElementById('clickRewardText');
        const sectorButtonsContainer = document.getElementById('sectorButtons');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        setLogLevel('debug');


        /**
         * 1. –ù–∞–¥–µ–∂–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.
         * @returns {string | null}
         */
        function getTelegramUserId() {
            if (typeof window.Telegram !== 'undefined' && window.Telegram.WebApp.initDataUnsafe.user) {
                // –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
                return window.Telegram.WebApp.initDataUnsafe.user.id.toString();
            }
            
            // --- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–Ω–µ Telegram ---
            const message = "‚ùå –û—à–∏–±–∫–∞: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–æ –≤–Ω—É—Ç—Ä–∏ Telegram —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —á–∞—Ç —Å –±–æ—Ç–æ–º –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å TashBoss Clicker'.";
            
            // –ï—Å–ª–∏ WebApp –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∑–∞–ø—É—Å–∫ –≤ –æ–±—ã—á–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ)
            if (typeof window.Telegram === 'undefined' || !window.Telegram.WebApp.initData) {
                console.error("Telegram WebApp SDK user data not found. App launched outside of Telegram.");
                statusMessage.classList.remove('hidden', 'text-yellow-400');
                statusMessage.classList.add('text-red-500');
                statusMessage.textContent = message;
                return null;
            }
            
            // –ï—Å–ª–∏ WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç (—Ä–µ–¥–∫–∏–π —Å–ª—É—á–∞–π)
            console.error("Telegram WebApp user data (initDataUnsafe.user) not found, but WebApp is initialized.");
            statusMessage.classList.remove('hidden', 'text-yellow-400');
            statusMessage.classList.add('text-red-500');
            statusMessage.textContent = message;
            return null;
        }

        /**
         * 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç Firebase Custom Token —É –±—ç–∫–µ–Ω–¥–∞.
         * @param {string} telegramUserId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.
         * @returns {Promise<string | null>} –¢–æ–∫–µ–Ω –∏–ª–∏ null –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
         */
        async function fetchCustomToken(telegramUserId) {
            try {
                statusMessage.textContent = "–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—à–∞–≥ 2/4)...";
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                const maxRetries = 3;
                for (let i = 0; i < maxRetries; i++) {
                    const response = await fetch(`${API_BASE_URL}/auth-token`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ telegram_user_id: telegramUserId })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.token;
                    }

                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        console.warn(`Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
                
                const errorData = await response.json().catch(() => ({ error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
                throw new Error(`–û—à–∏–±–∫–∞ HTTP –ø–æ—Å–ª–µ ${maxRetries} –ø–æ–ø—ã—Ç–æ–∫: ${response.status}. ${errorData.error}`);

            } catch (error) {
                console.error("Failed to fetch custom token:", error);
                statusMessage.textContent = `–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω. ${error.message}`;
                return null;
            }
        }

        /**
         * 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Firebase –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Ö–æ–¥.
         */
        async function initializeAppAndAuth(customToken) {
            try {
                statusMessage.textContent = "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (—à–∞–≥ 3/4)...";
                
                // –í Canvas __firebase_config –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥.
                // projectId –Ω—É–∂–µ–Ω –¥–ª—è getFirestore/getAuth.
                const firebaseConfig = { projectId: SECTORS_CONFIG.appId }; 
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                statusMessage.textContent = "–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É (—à–∞–≥ 4/4)...";

                // –í—Ö–æ–¥ —Å –ø–æ–º–æ—â—å—é Custom Token
                const userCredential = await signInWithCustomToken(auth, customToken);
                userId = userCredential.user.uid;
                
                console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ Firebase. User ID: ${userId}`);

                setupRealtimeListener();
                setupUI();

                // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                statusMessage.classList.add('hidden');
                gameContent.classList.remove('hidden');
                userIdDisplay.textContent = userId;

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                statusMessage.textContent = `–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏ –≤ Firebase. ${error.message}`;
                statusMessage.classList.remove('hidden');
            }
        }
        
        /**
         * 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å Firestore –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.
         */
        function setupRealtimeListener() {
            if (!db || !userId) return;

            // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å: /artifacts/{appId}/users/{userId}/data/state
            const docRef = doc(db, `artifacts/${SECTORS_CONFIG.appId}/users/${userId}/data/state`);

            onSnapshot(docRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    currentBalance = data.balance || 0;
                    currentSectorKey = data.sector || "sector1";
                    
                    balanceDisplay.textContent = new Intl.NumberFormat('ru-RU').format(currentBalance);
                    updateSectorSelectionUI(currentSectorKey);

                } else {
                    console.warn("User document not found. Waiting for backend initialization.");
                    balanceDisplay.textContent = new Intl.NumberFormat('ru-RU').format(0);
                }
            }, (error) => {
                console.error("Firestore real-time listener failed:", error);
                statusMessage.textContent = `–û—à–∏–±–∫–∞ Firestore: –ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. ${error.message}`;
                statusMessage.classList.remove('hidden');
            });
        }
        
        /**
         * –û–±–Ω–æ–≤–ª—è–µ—Ç UI –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å–µ–∫—Ç–æ—Ä–∞ –∏ —Ç–µ–∫—Å—Ç–∞ –Ω–∞–≥—Ä–∞–¥—ã.
         */
        function updateSectorSelectionUI(selectedKey) {
            const buttons = sectorButtonsContainer.querySelectorAll('.sector-button');
            buttons.forEach(button => {
                if (button.dataset.sectorKey === selectedKey) {
                    button.classList.add('bg-green-500', 'hover:bg-green-600', 'active:bg-green-700', 'border-2', 'border-white');
                    button.classList.remove('bg-indigo-600', 'hover:bg-indigo-700', 'active:bg-indigo-800');
                } else {
                    button.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'active:bg-indigo-800');
                    button.classList.remove('bg-green-500', 'hover:bg-green-600', 'active:bg-green-700', 'border-2', 'border-white');
                }
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ –∫–ª–∏–∫–∞
            const reward = SECTORS_CONFIG[selectedKey]?.click_value || 1;
            clickRewardText.textContent = `–ù–∞–≥—Ä–∞–¥–∞: +${reward}`;
        }
        
        /**
         * 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç UI –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π.
         */
        function setupUI() {
            clickButton.addEventListener('click', handleUserClick);
            
            Object.entries(SECTORS_CONFIG).forEach(([key, config]) => {
                if (key === 'appId') return; 

                const button = document.createElement('button');
                button.className = 'sector-button text-white bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 shadow-lg';
                button.textContent = config.name;
                button.dataset.sectorKey = key;
                
                button.addEventListener('click', () => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                    currentSectorKey = key;
                    updateSectorSelectionUI(key); 
                });
                
                sectorButtonsContainer.appendChild(button);
            });
            
            updateSectorSelectionUI(currentSectorKey); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
        }

        /**
         * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞: –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—ç–∫–µ–Ω–¥.
         */
        async function handleUserClick() {
            if (!userId) {
                console.error("User not authenticated.");
                return;
            }

            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–ø–∞–º-–∫–ª–∏–∫–∏
            clickButton.disabled = true;
            clickButton.style.opacity = 0.7;

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–µ–∫—É—â–∏–º —Å–µ–∫—Ç–æ—Ä–æ–º
                const response = await fetch(`${API_BASE_URL}/click`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, sector_key: currentSectorKey })
                });

                if (!response.ok) {
                    throw new Error("Backend click failed.");
                }
                
                console.log("Click processed by backend.");

            } catch (error) {
                console.error("Error processing click:", error);
            } finally {
                // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                clickButton.disabled = false;
                clickButton.style.opacity = 1.0;
            }
        }


        // --- –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ ---
        async function main() {
            statusMessage.textContent = "–ü–æ–ª—É—á–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (—à–∞–≥ 1/4)...";
            const telegramUserId = getTelegramUserId();

            if (!telegramUserId) {
                // getTelegramUserId —É–∂–µ –≤—ã–≤–æ–¥–∏—Ç –æ—à–∏–±–∫—É –≤ UI, –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å ID.
                return; 
            }

            statusMessage.textContent = "ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é —Ç–æ–∫–µ–Ω...";

            const customToken = await fetchCustomToken(telegramUserId);
            
            if (customToken) {
                await initializeAppAndAuth(customToken);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞
        main(); 
        
    </script>
</body>
</html>
